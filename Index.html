<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master The MRCS Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .main-app-container {
            max-width: 800px;
            width: 100%;
            margin: 1rem auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 2rem);
            position: relative; /* Needed for watermark positioning */
        }
        main {
            flex-grow: 1;
        }
        .action-btn {
            transition: all 0.2s ease-in-out;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .main-menu-btn {
            transition: all 0.3s ease-in-out;
            background-size: 200% 100%;
        }
        .main-menu-btn:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            background-position: right center;
        }
        .main-menu-btn.loading {
            cursor: not-allowed;
            background-image: none;
            background-color: #9ca3af;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Accordion styles for lectures */
        details summary::-webkit-details-marker {
            display: none;
        }
        details[open] > summary .fa-chevron-down {
            transform: rotate(180deg);
        }
        .lecture-viewed .view-toggle-icon {
            color: #22c55e; /* Green color for viewed lectures */
        }
        .lecture-viewed .lecture-name {
            color: #555;
            text-decoration: line-through;
        }
        .view-toggle-icon {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .view-toggle-icon:hover {
            transform: scale(1.2);
        }
        .note-icon.has-note {
            color: #f59e0b; /* Amber color for existing notes */
        }
        /* Styles from previous MCQ bank */
        .answer-btn.correct { background-color: #d1fae5; border-color: #10b981; color: #065f46; }
        .answer-btn.incorrect { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .answer-btn.user-choice { border-width: 3px; } /* Style for user's incorrect choice in review mode */
        .answer-btn:disabled { opacity: 0.8; cursor: not-allowed; }
        .rationale { visibility: hidden; opacity: 0; max-height: 0; transition: all 0.3s ease-in-out; overflow: hidden; }
        .rationale.visible { visibility: visible; opacity: 1; max-height: 150px; }
        .flag-btn.flagged { color: #f59e0b; }
        .bookmark-btn.bookmarked { color: #3b82f6; } /* Blue for bookmarked */
        .navigator-btn { position: relative; border: 2px solid transparent; }
        .navigator-btn.unanswered { background-color: #e5e7eb; border-color: #d1d5db; }
        .navigator-btn.correct { background-color: #d1fae5; border-color: #6ee7b7; }
        .navigator-btn.incorrect { background-color: #fee2e2; border-color: #fca5a5; }
        .navigator-btn .flag-icon { position: absolute; top: -4px; right: -4px; color: #f59e0b; font-size: 0.75rem; }
        .custom-exam-options { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
        .custom-exam-options.visible { max-height: 500px; padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .filter-container { max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.5rem; }
        .filter-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        /* Watermark Styles */
        #watermark-overlay {
            position: fixed;
            bottom: 10px;
            right: 10px;
            opacity: 0.25;
            pointer-events: none;
            z-index: 1000;
        }
        /* ADDED: Radio Banner Style */
        #radio-banner-container.open {
            max-height: 320px; /* h-64 (256px) for iframe + header */
        }
        /* ADDED: Styles for Learning Mode */
        .learning-answer-btn {
            background-color: #f3f4f6; /* bg-slate-100 */
            border: 1px solid #d1d5db; /* border-slate-300 */
        }
        .learning-answer-btn.correct {
            background-color: #d1fae5; /* bg-green-100 */
            border-color: #10b981; /* border-green-500 */
        }
        .learning-rationale {
            margin-top: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #065f46; /* text-green-800 */
            background-color: #d1fae5; /* bg-green-100 */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div class="main-app-container">
        <div id="watermark-overlay" class="hidden">
            </div>

        <header id="global-header" class="p-4 md:p-6 bg-slate-800 text-white flex justify-between items-center hidden">
            <a href="https://www.surgerymastersacademy.com" target="_blank" title="Back to Main Website">
                <img id="header-logo" src="https://raw.githubusercontent.com/surgerymastersacademy/MasterTheMRCS/cc0d28b70d6c4475fc05f336831ce9bad503b89c/Final%20MTM%20Round%20Logo%202024.png" alt="Logo" class="h-10">
            </a>
            <div class="flex items-center gap-4">
                <span id="user-name-display" class="text-base font-medium text-slate-200 hidden sm:block"></span>
                <button id="radio-btn" class="text-white hover:text-slate-300 transition-colors" title="MRCS Radio" aria-label="MRCS Radio">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m3.75 7.5 16.5-4.125M12 6.75c-2.708 0-5.363.224-7.948.655C2.999 7.58 2.25 8.507 2.25 9.574v9.176A2.25 2.25 0 0 0 4.5 21h15a2.25 2.25 0 0 0 2.25-2.25V9.574c0-1.067-.75-1.994-1.802-2.169A48.329 48.329 0 0 0 12 6.75Zm-1.683 6.443-.005.005-.006-.005.006-.005.005.005Zm-.005 2.127-.005-.006.005-.005.005.005-.005.005Zm-2.116-.006-.005.006-.006-.006.005-.005.006.005Zm-.005-2.116-.006-.005.006-.005.005.005-.005.005ZM9.255 10.5v.008h-.008V10.5h.008Zm3.249 1.88-.007.004-.003-.007.006-.003.004.006Zm-1.38 5.126-.003-.006.006-.004.004.007-.006.003Zm.007-6.501-.003.006-.007-.003.004-.007.006.004Zm1.37 5.129-.007-.004.004-.006.006.003-.004.007Zm.504-1.877h-.008v-.007h.008v.007ZM9.255 18v.008h-.008V18h.008Zm-3.246-1.87-.007.004L6 16.127l.006-.003.004.006Zm1.366-5.119-.004-.006.006-.004.004.007-.006.003ZM7.38 17.5l-.003.006-.007-.003.004-.007.006.004Zm-1.376-5.116L6 12.38l.003-.007.007.004-.004.007Zm-.5 1.873h-.008v-.007h.008v.007ZM17.25 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm0 4.5a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
                    </svg>
                </button>
                <button id="announcements-btn" class="text-white hover:text-slate-300 transition-colors text-2xl" title="Announcements" aria-label="Announcements">
                    <i class="fas fa-bullhorn"></i>
                </button>
                <button id="notes-btn" class="text-white hover:text-slate-300 transition-colors text-2xl" title="My Notes" aria-label="My Notes">
                    <i class="fas fa-book-open"></i>
                </button>
                <button id="activity-log-btn" class="text-white hover:text-slate-300 transition-colors text-2xl" title="Activity Log" aria-label="Activity Log">
                    <i class="fas fa-history"></i>
                </button>
                 <a href="https://t.me/DrBishoyAcademy" target="_blank" class="text-white hover:text-slate-300 transition-colors text-2xl" title="Contact Support"><i class="fas fa-headset"></i></a>
                <button id="global-home-btn" class="text-white hover:text-slate-300 transition-colors text-2xl" title="Back to Home" aria-label="Back to Home">
                    <i class="fas fa-home"></i>
                </button>
                 <button id="logout-btn" class="text-white hover:text-red-500 transition-colors text-2xl hidden" title="Logout" aria-label="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <div id="radio-banner-container" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out bg-slate-100">
            <div class="p-2 bg-slate-700 text-white flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-broadcast-tower"></i>
                    <h4 class="font-bold text-sm">MRCS Radio</h4>
                </div>
                <button id="radio-close-btn" class="text-xl hover:text-slate-300 px-2">&times;</button>
            </div>
            <iframe src="https://plasticologyradio.surgerymastersacademy.com/" class="w-full h-64 border-0" title="MRCS Radio"></iframe>
        </div>

        <main id="main-content">
            <div id="login-container" class="w-full max-w-md mx-auto">
                <div class="p-8">
                    <a href="https://www.surgerymastersacademy.com" target="_blank" title="Go to Main Website">
                        <img id="login-logo" src="https://raw.githubusercontent.com/surgerymastersacademy/MasterTheMRCS/cc0d28b70d6c4475fc05f336831ce9bad503b89c/Final%20MTM%20Round%20Logo%202024.png" alt="Logo" class="h-20 mx-auto mb-4">
                    </a>
                    <h1 class="text-2xl md:text-3xl font-bold text-center text-slate-800">Master The MRCS Ultimate Edition</h1>
                    <p class="text-slate-600 font-semibold text-center mt-4">Together We Can</p>
                    <p class="text-slate-500 text-center mt-2 mb-6">Please log in to continue.</p>
                    <div id="login-loader" class="loader hidden"></div>
                    <p id="login-loading-text" class="text-center text-slate-500 hidden">Loading data for guests...</p>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="username" class="block text-slate-700 text-sm font-bold mb-2">Username</label>
                            <input type="text" id="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-slate-700 text-sm font-bold mb-2">Password</label>
                            <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <p id="login-error" class="text-red-500 text-xs italic mb-4 hidden">Invalid username or password.</p>
                        <div class="flex flex-col gap-4">
                            <button type="submit" id="login-submit-btn" class="action-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                                Log In
                            </button>
                            <div class="relative flex py-2 items-center">
                                <div class="flex-grow border-t border-gray-300"></div>
                                <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                                <div class="flex-grow border-t border-gray-300"></div>
                            </div>
                            <button type="button" id="free-test-btn" class="action-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                                <i class="fas fa-vial mr-2"></i> Try a Free Test
                            </button>
                            <a href="https://www.youtube.com/playlist?list=PLVUDV5bqFz4jabLMYet03YmJknm8jA-wG" target="_blank" class="action-btn text-center w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                                <i class="fab fa-youtube mr-2"></i> Watch Sample Lectures
                            </a>
                             <a href="https://t.me/DrBishoyAcademy" target="_blank" class="action-btn text-center w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                                <i class="fab fa-telegram-plane mr-2"></i> Subscribe now for Ultimate Edition
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="main-menu-container" class="w-full hidden">
                <div class="p-6 md:p-8">
                    <div id="announcement-banner" class="hidden"></div>
                    <h2 class="text-3xl font-bold text-slate-800 text-center mb-2">Welcome to Master The MRCS Academy!</h2>
                    <div id="last-activity-container" class="space-y-2 my-6">
                        <div id="last-lecture-ribbon" class="hidden p-3 bg-teal-100 border border-teal-200 text-teal-800 rounded-lg text-center text-sm font-medium"></div>
                        <div id="last-quiz-ribbon" class="hidden p-3 bg-blue-100 border border-blue-200 text-blue-800 rounded-lg text-center text-sm font-medium"></div>
                    </div>
                    <p class="text-slate-500 text-center mb-8">Let’s get started – choose a section</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                        <button id="lectures-btn" class="main-menu-btn flex flex-col items-center justify-center p-8 rounded-xl text-white bg-gradient-to-r from-teal-500 to-cyan-600">
                            <i class="fas fa-video text-5xl mb-4"></i>
                            <span class="text-2xl font-bold">Lectures</span>
                            <span class="font-light">Watch & Learn</span>
                        </button>
                        <button id="qbank-btn" class="main-menu-btn flex flex-col items-center justify-center p-8 rounded-xl text-white bg-gradient-to-r from-indigo-500 to-purple-600">
                            <i class="fas fa-question-circle text-5xl mb-4"></i>
                            <span class="text-2xl font-bold">Exam Mode</span>
                            <span class="font-light">Test Your Knowledge</span>
                        </button>
                        <button id="learning-mode-btn" class="main-menu-btn flex flex-col items-center justify-center p-8 rounded-xl text-white bg-gradient-to-r from-green-500 to-emerald-600">
                            <i class="fas fa-book-reader text-5xl mb-4"></i>
                            <span class="text-2xl font-bold">Learning Mode</span>
                            <span class="font-light">Study Questions</span>
                        </button>
                        <button id="osce-btn" class="main-menu-btn flex flex-col items-center justify-center p-8 rounded-xl text-white bg-gradient-to-r from-sky-500 to-blue-600">
                            <i class="fas fa-user-md text-5xl mb-4"></i>
                            <span class="text-2xl font-bold">OSCE Bank</span>
                            <span class="font-light">Clinical Cases</span>
                        </button>
                        <button id="library-btn" class="main-menu-btn flex flex-col items-center justify-center p-8 rounded-xl text-white bg-gradient-to-r from-orange-500 to-amber-600">
                            <i class="fas fa-book-bookmark text-5xl mb-4"></i>
                            <span class="text-2xl font-bold">Library</span>
                            <span class="font-light">View Resources</span>
                        </button>
                        <button id="leaderboard-btn" class="main-menu-btn flex flex-col items-center justify-center p-8 rounded-xl text-white bg-gradient-to-r from-rose-500 to-pink-600">
                            <i class="fas fa-trophy text-5xl mb-4"></i>
                            <span class="text-2xl font-bold">Leaderboard</span>
                            <span class="font-light">Top 10 Users</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="library-container" class="w-full hidden">
                <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                    <button id="library-back-btn" class="text-slate-700 hover:text-blue-600 transition-colors" title="Back"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">Resource Library</h2>
                    <div class="w-16"></div> </div>
                <div class="p-4 md:p-6">
                    <div id="library-loader" class="loader hidden"></div>
                    <div id="library-list" class="space-y-4">
                    </div>
                </div>
            </div>

            <div id="leaderboard-container" class="w-full hidden">
                <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                    <button id="leaderboard-back-btn" class="text-slate-700 hover:text-blue-600 transition-colors" title="Back"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">Top 10 Champions</h2>
                    <div class="w-16"></div> </div>
                <div class="p-4 md:p-6">
                    <div id="leaderboard-loader" class="loader hidden"></div>
                    <div id="current-user-rank" class="mb-6"></div> 
                    <div id="leaderboard-list" class="space-y-3">
                        </div>
                </div>
            </div>

            <div id="lectures-container" class="w-full hidden">
                <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                    <button id="lectures-back-btn" class="text-slate-700 hover:text-blue-600 transition-colors" title="Back"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">Lectures</h2>
                    <div class="w-16"></div> </div>
                <div class="p-4 md:p-6">
                    <div class="relative mb-6">
                        <input type="text" id="lecture-search-input" placeholder="Search by chapter or topic..." class="w-full p-3 pl-10 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>
                    <div id="lectures-loader" class="loader"></div>
                    <div id="lectures-list" class="space-y-4">
                    </div>
                </div>
            </div>

            <div id="qbank-container" class="w-full hidden">
                 <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                    <button id="qbank-back-btn" class="text-slate-700 hover:text-blue-600 transition-colors" title="Back"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">Question Bank</h2>
                    <div class="w-16"></div> </div>
                <div id="qbank-controls" class="p-4 md:p-8 space-y-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center"><i class="fas fa-search text-indigo-500 mr-3"></i>Search for a Topic</h3>
                        <p class="text-slate-500 text-sm mb-4">Find questions related to a specific topic to start a quick quiz.</p>
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <input type="text" id="qbank-search-input" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Flaps, Burns...">
                            <button id="qbank-search-btn" class="action-btn w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                                Search
                            </button>
                        </div>
                        <p id="qbank-search-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                        <div id="qbank-search-results-container" class="mt-6 hidden">
                            <p id="qbank-search-results-info" class="text-center text-slate-600 font-semibold mb-4"></p>
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                                <input type="number" id="qbank-search-q-count" class="shadow-sm appearance-none border rounded w-full sm:w-1/3 py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="# of Qs (optional)">
                                <button id="qbank-start-search-quiz-btn" class="action-btn w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg">
                                    Start Quiz
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div id="loader" class="loader hidden"></div>
                        <p id="loading-text" class="text-slate-500 mt-2 text-center hidden">Loading questions...</p>
                        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center"><i class="fas fa-tasks text-emerald-500 mr-3"></i>Create a Mock Exam</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="relative">
                                <i class="fas fa-list-ol absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="number" id="mock-q-count" class="shadow-sm appearance-none border rounded w-full py-2 pl-10 pr-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="# of Qs" min="1">
                            </div>
                            <div class="relative">
                                <i class="fas fa-clock absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="number" id="custom-timer-input" class="shadow-sm appearance-none border rounded w-full py-2 pl-10 pr-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Time/Q (sec)" min="5">
                            </div>
                        </div>
                        <button id="toggle-custom-options-btn" class="action-btn w-full mt-4 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg">
                            Customize (Chapters & Sources) <i class="fas fa-chevron-down ml-2 transition-transform"></i>
                        </button>
                        <div id="custom-exam-options" class="custom-exam-options mt-4">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                 <div>
                                     <label for="chapter-select-mock" class="block text-sm font-medium text-slate-700 mb-2">Filter by Chapters (optional)</label>
                                      <div class="flex items-center p-2 border-b">
                                        <input id="select-all-chapters-mock" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <label for="select-all-chapters-mock" class="ml-3 font-bold text-gray-700">Select All</label>
                                      </div>
                                     <div id="chapter-select-mock" class="filter-container space-y-2">
                                         <p class="text-slate-400">Loading chapters...</p>
                                     </div>
                                 </div>
                                 <div>
                                     <label for="source-select-mock" class="block text-sm font-medium text-slate-700 mb-2">Filter by Sources (optional)</label>
                                     <div class="flex items-center p-2 border-b">
                                        <input id="select-all-sources-mock" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <label for="select-all-sources-mock" class="ml-3 font-bold text-gray-700">Select All</label>
                                      </div>
                                     <div id="source-select-mock" class="filter-container space-y-2">
                                         <p class="text-slate-400">Loading sources...</p>
                                     </div>
                                 </div>
                             </div>
                        </div>
                        <button id="start-mock-btn" class="action-btn w-full mt-6 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg">
                            Start Mock Exam
                        </button>
                        <p id="mock-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center"><i class="fas fa-flag-checkered text-rose-500 mr-3"></i>Exam Simulation Mode</h3>
                        <p class="text-slate-500 text-sm mb-4">Start a full exam simulation with a fixed timer and no immediate feedback, just like the real exam. Results will be shown only at the end.</p>
                        <button id="start-simulation-btn" class="action-btn w-full mt-2 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-4 rounded-lg">
                            Start Full Simulation
                        </button>
                        <p id="simulation-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center"><i class="fas fa-book-open-reader text-purple-500 mr-3"></i>Browse & Practice</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="browse-by-chapter-btn" class="action-btn w-full bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg">Browse by Chapter</button>
                            <button id="browse-by-source-btn" class="action-btn w-full bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg">Browse by Source</button>
                            <button id="practice-mistakes-btn" class="action-btn w-full bg-orange-100 hover:bg-orange-200 text-orange-800 font-bold py-3 px-6 rounded-lg">Practice Mistakes</button>
                            <button id="practice-bookmarked-btn" class="action-btn w-full bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-3 px-6 rounded-lg">Practice Bookmarked</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="osce-container" class="w-full hidden">
                <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                    <button id="osce-back-btn" class="text-slate-700 hover:text-blue-600 transition-colors" title="Back"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">OSCE Bank</h2>
                    <div class="w-16"></div> </div>
                <div id="osce-controls">
                    <div class="p-6 md:p-8 border-b border-slate-200">
                        <h3 class="text-2xl font-bold text-slate-800 mb-2 text-center">OSCE Slayer</h3>
                        <p class="text-center text-slate-500 mb-4">Test yourself in all available clinical cases.</p>
                        <button id="start-osce-slayer-btn" class="action-btn w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-4 rounded-lg">
                            Start OSCE Slayer
                        </button>
                    </div>
                    <div class="p-6 md:p-8">
                        <h3 class="text-2xl font-bold text-slate-800 mb-4 text-center">Custom OSCE</h3>
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <input type="number" id="osce-case-count" class="shadow appearance-none border rounded w-full sm:w-1/2 py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="# of Cases" min="1">
                            <input type="number" id="osce-time-per-q" class="shadow appearance-none border rounded w-full sm:w-1/2 py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Mins/Question (Default: 1)" min="1">
                            <button id="toggle-osce-options-btn" class="action-btn w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                                Customize
                            </button>
                        </div>
                        <div id="custom-osce-options" class="custom-exam-options mt-4">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                 <div>
                                     <label for="chapter-select-osce" class="block text-sm font-medium text-slate-700 mb-2">Filter by Chapters (optional)</label>
                                     <div id="chapter-select-osce" class="filter-container space-y-2">
                                         <p class="text-slate-400">Loading chapters...</p>
                                     </div>
                                 </div>
                                 <div>
                                     <label for="source-select-osce" class="block text-sm font-medium text-slate-700 mb-2">Filter by Sources (optional)</label>
                                     <div id="source-select-osce" class="filter-container space-y-2">
                                         <p class="text-slate-400">Loading sources...</p>
                                     </div>
                                 </div>
                             </div>
                        </div>
                        <button id="start-custom-osce-btn" class="action-btn w-full mt-6 bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg">
                            Start Custom OSCE
                        </button>
                        <p id="osce-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                    </div>
                </div>
            </div>

            <div id="osce-quiz-container" class="w-full hidden flex flex-col h-full">
                 <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <button id="end-osce-quiz-btn" class="text-slate-600 hover:text-red-600 transition-colors text-2xl" title="End OSCE Quiz" aria-label="End OSCE Quiz"><i class="fas fa-stop-circle"></i></button>
                    </div>
                    <h2 id="osce-quiz-title" class="text-lg md:text-xl font-bold text-slate-800 text-center mx-2 truncate"></h2>
                    <div class="flex items-center gap-4">
                        <div id="osce-score" class="text-lg font-mono bg-blue-200 text-blue-800 px-3 py-1 rounded-md">Score: 0/0</div>
                        <div id="osce-timer" class="text-lg font-mono bg-slate-200 text-slate-800 px-3 py-1 rounded-md">--:--</div>
                    </div>
                </div>
                <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 p-4 overflow-y-auto">
                    <div class="bg-slate-50 p-4 rounded-lg flex flex-col">
                        <h3 id="osce-case-title" class="text-xl font-bold text-slate-800 mb-2"></h3>
                        <div id="osce-case-image-container" class="mb-2 text-center flex-grow flex items-center justify-center">
                             </div>
                        <p id="osce-case-description" class="text-sm text-slate-600"></p>
                    </div>
                    <div class="flex flex-col">
                        <p id="osce-progress-text" class="font-semibold text-slate-600 text-center mb-2"></p>
                        <div class="bg-white p-4 rounded-lg border flex-grow flex flex-col">
                            <div id="osce-question-image-container" class="mb-4 text-center"></div>
                            <h3 id="osce-question-text" class="text-lg font-semibold text-slate-800 mb-4"></h3>
                            <div id="osce-answer-area" class="space-y-3 flex-grow">
                                </div>
                            <div id="osce-model-answer-area" class="mt-4 hidden p-3 bg-gray-100 rounded"></div>
                            <div id="osce-self-correction-area" class="mt-4 hidden"></div>
                            <div id="osce-controls-container" class="mt-4 flex justify-between items-center">
                                <button id="osce-previous-btn" class="action-btn bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-400">Previous</button>
                                <button id="osce-navigator-btn" class="text-2xl text-slate-500 hover:text-blue-600 transition-colors" title="Case & Question Navigator" aria-label="Case & Question Navigator"><i class="fas fa-th-list"></i></button>
                                <button id="osce-next-btn" class="action-btn bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="list-container" class="w-full hidden">
                 <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                    <button id="list-back-btn" class="text-slate-700 hover:text-blue-600 transition-colors" title="Back"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 id="list-title" class="text-xl md:text-2xl font-bold text-slate-800"></h2>
                    <div class="w-16"></div> </div>
                <div id="list-items" class="p-4 md:p-6 grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4"></div>
            </div>

            <div id="notes-container" class="w-full hidden">
                <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                    <button id="notes-back-btn" class="text-slate-700 hover:text-blue-600 transition-colors" title="Back"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">My Notes</h2>
                    <div class="w-16"></div> </div>
                <div class="p-6 md:p-8">
                    <div class="mb-4 p-1 bg-slate-200 rounded-lg flex justify-center gap-1">
                        <button id="notes-filter-quizzes" class="filter-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors">Quiz Notes</button>
                        <button id="notes-filter-lectures" class="filter-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors">Lecture Notes</button>
                    </div>
                    <div id="notes-list" class="space-y-3 max-h-[70vh] overflow-y-auto">
                    </div>
                </div>
            </div>

            <div id="activity-log-container" class="w-full hidden">
                <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                    <button id="activity-back-btn" class="text-slate-700 hover:text-blue-600 transition-colors" title="Back"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">Activity Log</h2>
                    <button id="clear-log-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg">Clear Log</button>
                </div>
                <div class="p-6 md:p-8">
                    <div class="mb-4 p-1 bg-slate-200 rounded-lg flex justify-center gap-1">
                        <button id="log-filter-all" class="filter-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors">All</button>
                        <button id="log-filter-quizzes" class="filter-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors">Quizzes</button>
                        <button id="log-filter-lectures" class="filter-btn flex-1 py-2 px-4 rounded-md text-sm font-semibold transition-colors">Lectures</button>
                    </div>
                    
                    <div id="all-summary" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 hidden">
                        <div class="bg-teal-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-teal-800 font-semibold">Lectures Progress</p>
                            <p id="all-lectures-progress" class="text-2xl font-bold text-teal-900"></p>
                        </div>
                        <div class="bg-sky-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-sky-800 font-semibold">Questions Progress</p>
                            <p id="all-questions-progress" class="text-2xl font-bold text-sky-900"></p>
                        </div>
                    </div>

                    <div id="quiz-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden">
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-green-800 font-semibold">Total Correct Answers</p>
                            <p id="total-correct-answers" class="text-2xl font-bold text-green-900"></p>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-red-800 font-semibold">Total Incorrect Answers</p>
                            <p id="total-incorrect-answers" class="text-2xl font-bold text-red-900"></p>
                        </div>
                        <div class="bg-yellow-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-yellow-800 font-semibold">Overall Accuracy</p>
                            <p id="overall-accuracy" class="text-2xl font-bold text-yellow-900"></p>
                        </div>
                    </div>

                    <div id="lecture-summary" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 hidden">
                        <div class="bg-indigo-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-indigo-800 font-semibold">Lectures Viewed</p>
                            <p id="lectures-viewed-count" class="text-2xl font-bold text-indigo-900"></p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-purple-800 font-semibold">Chapters Started</p>
                            <p id="chapters-started-count" class="text-2xl font-bold text-purple-900"></p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <canvas id="activity-chart"></canvas>
                    </div>

                    <div id="activity-log-list" class="space-y-3 max-h-[40vh] overflow-y-auto">
                    </div>
                </div>
            </div>

            <div id="quiz-container" class="w-full hidden">
                 <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <button id="end-quiz-btn" class="text-slate-600 hover:text-red-600 transition-colors text-2xl" title="End Quiz" aria-label="End Quiz"><i class="fas fa-stop-circle"></i></button>
                    </div>
                    <h2 id="quiz-title" class="text-lg md:text-2xl font-bold text-slate-800 text-center mx-2 truncate"></h2>
                    <div id="timer" class="text-lg font-mono bg-slate-200 text-slate-800 px-3 py-1 rounded-md">00:00</div>
                </div>
                <div class="px-6 md:px-8 pt-6">
                    <div class="flex justify-between items-center mb-1 text-sm font-medium text-slate-600">
                        <span>Progress</span>
                        <span id="score-progress-text">Score: 0/0</span>
                    </div>
                    <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="flex h-2.5 rounded-full">
                            <div id="score-bar-correct" class="bg-emerald-500 transition-all duration-500" style="width: 0%;"></div>
                            <div id="score-bar-incorrect" class="bg-red-500 transition-all duration-500" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div class="p-6 md:p-8">
                    <div class="text-center mb-4">
                        <p id="progress-text" class="font-semibold text-slate-600">Loading question...</p>
                        <p id="source-text" class="text-sm text-slate-400 mt-1"></p>
                    </div>
                    <div id="question-image-container" class="mb-4 text-center"></div>
                    <div id="question-container">
                        <h2 id="question-text" class="text-xl md:text-2xl font-semibold text-slate-800 mb-6 leading-relaxed"></h2>
                        <div id="answer-buttons-quiz" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                    <div id="controls-container" class="mt-8 flex justify-between items-center">
                        <button id="previous-btn" class="bg-slate-300 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-400 transition-colors action-btn">Previous</button>
                        <div class="flex items-center gap-4">
                             <button id="navigator-btn" class="text-2xl text-slate-500 hover:text-blue-600 transition-colors" title="Question Navigator" aria-label="Question Navigator"><i class="fas fa-th"></i></button>
                            <button id="bookmark-btn" class="bookmark-btn text-2xl text-slate-400 hover:text-blue-500 transition-colors" title="Bookmark Question" aria-label="Bookmark Question"><i class="far fa-bookmark"></i></button>
                            <button id="flag-btn" class="flag-btn text-2xl text-slate-400 hover:text-amber-500 transition-colors" title="Flag for Review" aria-label="Flag for Review"><i class="far fa-flag"></i></button>
                            <button id="hint-btn" class="text-2xl text-slate-500 hover:text-yellow-500 transition-colors" title="Show Hint" aria-label="Show Hint"><i class="fas fa-lightbulb"></i></button>
                            <button id="quiz-note-btn" class="text-2xl text-slate-500 hover:text-amber-500 transition-colors note-icon" title="My Note"><i class="fas fa-sticky-note"></i></button>
                        </div>
                        <button id="next-skip-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors action-btn">Next</button>
                    </div>
                    <div id="hint-text" class="p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 rounded-md w-full text-center mt-4 hidden"></div>
                    <div id="results-container" class="hidden text-center p-6">
                        <h2 id="results-title" class="text-3xl font-bold text-slate-800">Quiz Complete!</h2>
                        <p id="results-score-text" class="text-xl mt-4">Your score is <span id="score-text" class="font-bold"></span> out of <span id="total-questions" class="font-bold"></span>.</p>
                        <div id="results-buttons" class="mt-8 flex flex-wrap justify-center gap-4">
                            <button id="results-home-btn" class="action-btn bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700">Go to Home</button>
                            <button id="restart-btn" class="action-btn bg-slate-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-900">Restart Quiz</button>
                            <button id="review-incorrect-btn" class="action-btn bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 hidden">Review Incorrect</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="learning-mode-container" class="w-full hidden">
                <div id="learning-mode-controls">
                     <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                        <button id="learning-mode-back-btn" class="text-slate-700 hover:text-blue-600 transition-colors" title="Back"><i class="fas fa-arrow-left"></i> Back</button>
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800">Learning Mode</h2>
                        <div class="w-16"></div> </div>
                    <div class="p-6 md:p-8">
                        <h3 class="text-xl font-bold text-slate-800 mb-4 text-center">Search for a Topic</h3>
                        <div class="relative flex items-center mb-6">
                            <input type="text" id="learning-search-input" placeholder="e.g., Flaps, Burns, Nerve..." class="w-full p-3 pl-10 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                            <button id="learning-search-btn" class="absolute right-2 bg-blue-600 text-white rounded-lg px-4 py-1.5 hover:bg-blue-700">Search</button>
                        </div>
                        <p id="learning-search-error" class="text-red-500 text-xs italic text-center hidden"></p>
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>
                         <h3 class="text-xl font-bold text-slate-800 mb-4 text-center">Browse Questions to Study</h3>
                         <p class="text-center text-slate-500 mb-6">Select a category to start learning. Questions will be displayed with their answers.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="learning-browse-by-chapter-btn" class="action-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Browse by Chapter</button>
                            <button id="learning-browse-by-source-btn" class="action-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Browse by Source</button>
                        </div>
                    </div>
                </div>
                <div id="learning-mode-viewer" class="hidden">
                       <div class="p-4 md:p-6 bg-slate-100 border-b flex justify-between items-center">
                        <button id="end-learning-btn" class="text-slate-600 hover:text-red-600 transition-colors" title="End Session"><i class="fas fa-stop-circle text-2xl"></i></button>
                        <h2 id="learning-title" class="text-lg md:text-2xl font-bold text-slate-800 text-center mx-2 truncate"></h2>
                        <div class="w-16"></div> </div>
                    <div class="p-6 md:p-8">
                         <div class="text-center mb-4">
                            <p id="learning-progress-text" class="font-semibold text-slate-600">Loading question...</p>
                            <p id="learning-source-text" class="text-sm text-slate-400 mt-1"></p>
                        </div>
                        <div id="learning-image-container" class="mb-4 text-center"></div>
                        <div>
                            <h2 id="learning-question-text" class="text-xl md:text-2xl font-semibold text-slate-800 mb-6 leading-relaxed"></h2>
                            <div id="learning-answer-buttons" class="space-y-4"></div>
                        </div>
                        <div class="mt-8 flex justify-between items-center">
                            <button id="learning-previous-btn" class="bg-slate-300 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-400 transition-colors action-btn">Previous</button>
                            <button id="learning-next-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors action-btn">Next</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        <footer id="app-footer" class="text-center p-4 bg-slate-100 text-xs text-slate-500 border-t">
            Copyright © Surgery Masters Academy Dr.Bishoy
        </footer>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="confirmation-modal" class="bg-white rounded-lg p-8 shadow-xl max-w-sm w-full hidden">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Are you sure?</h3>
            <p id="modal-text" class="text-slate-600 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="action-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
                <button id="modal-confirm-btn" class="action-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirm</button>
            </div>
        </div>
        <div id="question-navigator-modal" class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full hidden">
            <h3 class="text-xl font-bold mb-4">Question Navigator</h3>
            <div id="navigator-grid" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2 max-h-64 overflow-y-auto"></div>
            <div class="flex justify-end mt-6">
                <button id="navigator-close-btn" class="action-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Close</button>
            </div>
        </div>
        <div id="osce-navigator-modal" class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full hidden">
            <h3 class="text-xl font-bold mb-4">Case & Question Navigator</h3>
            <div id="osce-navigator-content" class="space-y-2 max-h-80 overflow-y-auto"></div>
            <div class="flex justify-end mt-6">
                <button id="osce-navigator-close-btn" class="action-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Close</button>
            </div>
        </div>
        <div id="image-viewer-modal" class="bg-white rounded-lg p-4 shadow-xl max-w-4xl w-full hidden relative">
            <button id="image-viewer-close-btn" class="absolute top-2 right-2 text-2xl text-gray-600 hover:text-black">&times;</button>
            <img id="modal-image" src="" alt="Full size image" class="max-w-full max-h-[80vh] mx-auto">
        </div>
        <div id="note-modal" class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full hidden">
            <h3 id="note-modal-title" class="text-xl font-bold mb-4">My Note</h3>
            <textarea id="note-textarea" class="w-full h-40 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Write your personal note here..."></textarea>
            <div class="flex justify-end gap-4 mt-4">
                <button id="note-cancel-btn" class="action-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
                <button id="note-save-btn" class="action-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save</button>
            </div>
        </div>
        <div id="clear-log-modal" class="bg-white rounded-lg p-8 shadow-xl max-w-md w-full hidden">
            <h3 class="text-xl font-bold mb-4">Clear Activity Log</h3>
            <p class="text-slate-600 mb-6">Which logs would you like to permanently delete?</p>
            <div class="flex flex-col gap-4">
                <button id="clear-quiz-logs-btn" class="action-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Clear Quiz Logs Only</button>
                <button id="clear-lecture-logs-btn" class="action-btn w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">Clear Lecture Logs Only</button>
                <button id="clear-all-logs-btn" class="action-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Clear All Logs</button>
            </div>
            <div class="flex justify-end mt-6">
                <button id="clear-log-cancel-btn" class="action-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
            </div>
        </div>
        <div id="announcements-modal" class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full hidden">
            <h3 class="text-xl font-bold mb-4">Latest Updates & Announcements</h3>
            <div id="announcements-list" class="space-y-4 max-h-80 overflow-y-auto"></div>
            <div class="flex justify-end mt-6">
                <button id="announcements-close-btn" class="action-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Close</button>
            </div>
        </div>
        </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- URL FOR GOOGLE SHEETS ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbwNkMdB4tp7yAY7VOIAnV4MpC6cwv1GzACw-WjMHzcfEBwQs60KGR5XhjIITjP_hQOD/exec';
        
        // --- START: NEW SIMULATION SETTINGS ---
        const SIMULATION_Q_COUNT = 100; // The number of questions for the simulation
        const SIMULATION_TOTAL_TIME_MINUTES = 120; // The total time in minutes for the simulation
        // --- END: NEW SIMULATION SETTINGS ---
        
        // --- REFACTORED: Centralized Application State ---
        const appState = {
            // Content Data
            allQuestions: [],
            allOsceCases: [],
            allOsceQuestions: [],
            groupedLectures: {},
            mcqBooks: [],
            allAnnouncements: [],
            
            // User Data
            currentUser: null,
            viewedLectures: new Set(),
            bookmarkedQuestions: new Set(),
            fullActivityLog: [],
            userQuizNotes: [],
            userLectureNotes: [],

            // Navigation
            navigationHistory: [],

            // Current Quiz State
            currentQuiz: {
                questions: [],
                originalQuestions: [],
                userAnswers: [],
                originalUserAnswers: [],
                currentQuestionIndex: 0,
                score: 0,
                timerInterval: null,
                simulationTimerInterval: null, // ADDED
                flaggedIndices: new Set(),
                isReviewMode: false,
                isSimulationMode: false, // ADDED
                isPracticingMistakes: false,
                timePerQuestion: 45, // Default time
            },

            // Current OSCE State
            currentOsce: {
                cases: [],
                caseIndex: 0,
                questionIndex: 0,
                timerInterval: null,
                userAnswers: {},
                score: 0,
                totalQuestions: 0,
            },
            
            // ADDED: Current Learning Mode State
            currentLearning: {
                questions: [],
                currentIndex: 0,
                title: ''
            },

            // UI State
            activityChartInstance: null,
            currentNote: { type: null, itemId: null, itemTitle: null },
            modalConfirmAction: null,
            qbankSearchResults: [], // To store search results
        };
        
        const DEFAULT_TIME_PER_QUESTION = 45;

        // --- DOM ELEMENTS ---
        const globalHeader = document.getElementById('global-header');
        const globalHomeBtn = document.getElementById('global-home-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const activityLogBtn = document.getElementById('activity-log-btn');
        const notesBtn = document.getElementById('notes-btn');
        const announcementsBtn = document.getElementById('announcements-btn');
        const userNameDisplay = document.getElementById('user-name-display');
        const loginContainer = document.getElementById('login-container');
        const mainMenuContainer = document.getElementById('main-menu-container');
        const lecturesContainer = document.getElementById('lectures-container');
        const qbankContainer = document.getElementById('qbank-container');
        const listContainer = document.getElementById('list-container');
        const quizContainer = document.getElementById('quiz-container');
        const activityLogContainer = document.getElementById('activity-log-container');
        const notesContainer = document.getElementById('notes-container');
        const libraryContainer = document.getElementById('library-container');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const loginForm = document.getElementById('login-form');
        const loginLoader = document.getElementById('login-loader');
        const loginLoadingText = document.getElementById('login-loading-text');
        const loginError = document.getElementById('login-error');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const freeTestBtn = document.getElementById('free-test-btn');
        const lecturesBtn = document.getElementById('lectures-btn');
        const qbankBtn = document.getElementById('qbank-btn');
        const libraryBtn = document.getElementById('library-btn');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const lastLectureRibbon = document.getElementById('last-lecture-ribbon');
        const lastQuizRibbon = document.getElementById('last-quiz-ribbon');
        const libraryBackBtn = document.getElementById('library-back-btn');
        const libraryLoader = document.getElementById('library-loader');
        const libraryList = document.getElementById('library-list');
        const leaderboardBackBtn = document.getElementById('leaderboard-back-btn');
        const leaderboardLoader = document.getElementById('leaderboard-loader');
        const leaderboardList = document.getElementById('leaderboard-list');
        const currentUserRankDiv = document.getElementById('current-user-rank');
        const lecturesBackBtn = document.getElementById('lectures-back-btn');
        const lectureSearchInput = document.getElementById('lecture-search-input');
        const lecturesLoader = document.getElementById('lectures-loader');
        const lecturesList = document.getElementById('lectures-list');
        const notesBackBtn = document.getElementById('notes-back-btn');
        const notesFilterQuizzes = document.getElementById('notes-filter-quizzes');
        const notesFilterLectures = document.getElementById('notes-filter-lectures');
        const notesList = document.getElementById('notes-list');
        const activityBackBtn = document.getElementById('activity-back-btn');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const allSummary = document.getElementById('all-summary');
        const quizSummary = document.getElementById('quiz-summary');
        const lectureSummary = document.getElementById('lecture-summary');
        const allLecturesProgress = document.getElementById('all-lectures-progress');
        const allQuestionsProgress = document.getElementById('all-questions-progress');
        const totalCorrectAnswers = document.getElementById('total-correct-answers');
        const totalIncorrectAnswers = document.getElementById('total-incorrect-answers');
        const overallAccuracy = document.getElementById('overall-accuracy');
        const lecturesViewedCount = document.getElementById('lectures-viewed-count');
        const chaptersStartedCount = document.getElementById('chapters-started-count');
        const activityLogList = document.getElementById('activity-log-list');
        const logFilterAll = document.getElementById('log-filter-all');
        const logFilterQuizzes = document.getElementById('log-filter-quizzes');
        const logFilterLectures = document.getElementById('log-filter-lectures');
        const activityChartCanvas = document.getElementById('activity-chart');
        const qbankBackBtn = document.getElementById('qbank-back-btn');
        const loader = document.getElementById('loader');
        const loadingText = document.getElementById('loading-text');
        const mockQCountInput = document.getElementById('mock-q-count');
        const customTimerInput = document.getElementById('custom-timer-input');
        const toggleCustomOptionsBtn = document.getElementById('toggle-custom-options-btn');
        const customExamOptions = document.getElementById('custom-exam-options');
        const chapterSelectMock = document.getElementById('chapter-select-mock');
        const sourceSelectMock = document.getElementById('source-select-mock');
        const startMockBtn = document.getElementById('start-mock-btn');
        const mockError = document.getElementById('mock-error');
        const browseByChapterBtn = document.getElementById('browse-by-chapter-btn');
        const browseBySourceBtn = document.getElementById('browse-by-source-btn');
        const practiceMistakesBtn = document.getElementById('practice-mistakes-btn');
        const listBackBtn = document.getElementById('list-back-btn');
        const listTitle = document.getElementById('list-title');
        const listItems = document.getElementById('list-items');
        const quizTitle = document.getElementById('quiz-title');
        const timerDisplay = document.getElementById('timer');
        const progressText = document.getElementById('progress-text');
        const sourceText = document.getElementById('source-text');
        const questionText = document.getElementById('question-text');
        const questionImageContainer = document.getElementById('question-image-container');
        const answerButtons = document.getElementById('answer-buttons-quiz');
        const questionContainer = document.getElementById('question-container');
        const controlsContainer = document.getElementById('controls-container');
        const hintBtn = document.getElementById('hint-btn');
        const hintText = document.getElementById('hint-text');
        const previousBtn = document.getElementById('previous-btn');
        const nextSkipBtn = document.getElementById('next-skip-btn');
        const flagBtn = document.getElementById('flag-btn');
        const quizNoteBtn = document.getElementById('quiz-note-btn');
        const endQuizBtn = document.getElementById('end-quiz-btn');
        const scoreProgressText = document.getElementById('score-progress-text');
        const scoreBarCorrect = document.getElementById('score-bar-correct');
        const scoreBarIncorrect = document.getElementById('score-bar-incorrect');
        const resultsContainer = document.getElementById('results-container');
        const resultsTitle = document.getElementById('results-title');
        const resultsScoreText = document.getElementById('results-score-text');
        const scoreText = document.getElementById('score-text');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const restartBtn = document.getElementById('restart-btn');
        const resultsHomeBtn = document.getElementById('results-home-btn');
        const reviewIncorrectBtn = document.getElementById('review-incorrect-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const questionNavigatorModal = document.getElementById('question-navigator-modal');
        const navigatorBtn = document.getElementById('navigator-btn');
        const navigatorGrid = document.getElementById('navigator-grid');
        const navigatorCloseBtn = document.getElementById('navigator-close-btn');
        const imageViewerModal = document.getElementById('image-viewer-modal');
        const modalImage = document.getElementById('modal-image');
        const imageViewerCloseBtn = document.getElementById('image-viewer-close-btn');
        const noteModal = document.getElementById('note-modal');
        const noteModalTitle = document.getElementById('note-modal-title');
        const noteTextarea = document.getElementById('note-textarea');
        const noteSaveBtn = document.getElementById('note-save-btn');
        const noteCancelBtn = document.getElementById('note-cancel-btn');
        const clearLogModal = document.getElementById('clear-log-modal');
        const clearQuizLogsBtn = document.getElementById('clear-quiz-logs-btn');
        const clearLectureLogsBtn = document.getElementById('clear-lecture-logs-btn');
        const clearAllLogsBtn = document.getElementById('clear-all-logs-btn');
        const clearLogCancelBtn = document.getElementById('clear-log-cancel-btn');
        const announcementsModal = document.getElementById('announcements-modal');
        const announcementsList = document.getElementById('announcements-list');
        const announcementsCloseBtn = document.getElementById('announcements-close-btn');
        const osceBtn = document.getElementById('osce-btn');
        const osceContainer = document.getElementById('osce-container');
        const osceQuizContainer = document.getElementById('osce-quiz-container');
        const osceBackBtn = document.getElementById('osce-back-btn');
        const startOsceSlayerBtn = document.getElementById('start-osce-slayer-btn');
        const osceCaseCountInput = document.getElementById('osce-case-count');
        const osceTimePerQInput = document.getElementById('osce-time-per-q');
        const toggleOsceOptionsBtn = document.getElementById('toggle-osce-options-btn');
        const customOsceOptions = document.getElementById('custom-osce-options');
        const chapterSelectOsce = document.getElementById('chapter-select-osce');
        const sourceSelectOsce = document.getElementById('source-select-osce');
        const startCustomOsceBtn = document.getElementById('start-custom-osce-btn');
        const osceError = document.getElementById('osce-error');
        const endOsceQuizBtn = document.getElementById('end-osce-quiz-btn');
        const osceQuizTitle = document.getElementById('osce-quiz-title');
        const osceTimer = document.getElementById('osce-timer');
        const osceCaseTitle = document.getElementById('osce-case-title');
        const osceCaseImageContainer = document.getElementById('osce-case-image-container');
        const osceCaseDescription = document.getElementById('osce-case-description');
        const osceProgressText = document.getElementById('osce-progress-text');
        const osceQuestionImageContainer = document.getElementById('osce-question-image-container');
        const osceQuestionText = document.getElementById('osce-question-text');
        const osceAnswerArea = document.getElementById('osce-answer-area');
        const osceModelAnswerArea = document.getElementById('osce-model-answer-area');
        const oscePreviousBtn = document.getElementById('osce-previous-btn');
        const osceNextBtn = document.getElementById('osce-next-btn');
        const radioBtn = document.getElementById('radio-btn');
        const radioCloseBtn = document.getElementById('radio-close-btn');
        const osceScoreDisplay = document.getElementById('osce-score');
        const osceNavigatorBtn = document.getElementById('osce-navigator-btn');
        const osceNavigatorModal = document.getElementById('osce-navigator-modal');
        const osceNavigatorContent = document.getElementById('osce-navigator-content');
        const osceNavigatorCloseBtn = document.getElementById('osce-navigator-close-btn');
        const osceSelfCorrectionArea = document.getElementById('osce-self-correction-area');
        const radioBannerContainer = document.getElementById('radio-banner-container');
        
        const learningModeBtn = document.getElementById('learning-mode-btn');
        const learningModeContainer = document.getElementById('learning-mode-container');
        const learningModeControls = document.getElementById('learning-mode-controls');
        const learningModeViewer = document.getElementById('learning-mode-viewer');
        const learningModeBackBtn = document.getElementById('learning-mode-back-btn');
        const learningBrowseByChapterBtn = document.getElementById('learning-browse-by-chapter-btn');
        const learningBrowseBySourceBtn = document.getElementById('learning-browse-by-source-btn');
        const endLearningBtn = document.getElementById('end-learning-btn');
        const learningTitle = document.getElementById('learning-title');
        const learningProgressText = document.getElementById('learning-progress-text');
        const learningSourceText = document.getElementById('learning-source-text');
        const learningImageContainer = document.getElementById('learning-image-container');
        const learningQuestionText = document.getElementById('learning-question-text');
        const learningAnswerButtons = document.getElementById('learning-answer-buttons');
        const learningPreviousBtn = document.getElementById('learning-previous-btn');
        const learningNextBtn = document.getElementById('learning-next-btn');
        const learningSearchInput = document.getElementById('learning-search-input');
        const learningSearchBtn = document.getElementById('learning-search-btn');
        const learningSearchError = document.getElementById('learning-search-error');
        const qbankSearchInput = document.getElementById('qbank-search-input');
        const qbankSearchQCount = document.getElementById('qbank-search-q-count');
        const qbankSearchBtn = document.getElementById('qbank-search-btn');
        const qbankSearchError = document.getElementById('qbank-search-error');
        const qbankSearchResultsContainer = document.getElementById('qbank-search-results-container');
        const qbankSearchResultsInfo = document.getElementById('qbank-search-results-info');
        const qbankStartSearchQuizBtn = document.getElementById('qbank-start-search-quiz-btn');
        const selectAllSourcesMock = document.getElementById('select-all-sources-mock');
        const selectAllChaptersMock = document.getElementById('select-all-chapters-mock');
        const practiceBookmarkedBtn = document.getElementById('practice-bookmarked-btn');
        const bookmarkBtn = document.getElementById('bookmark-btn');
        
        // --- START: NEW SIMULATION DOM ELEMENTS ---
        const startSimulationBtn = document.getElementById('start-simulation-btn');
        const simulationError = document.getElementById('simulation-error');
        // --- END: NEW SIMULATION DOM ELEMENTS ---

        // --- FUNCTIONS ---
        
        function logUserActivity(eventData) {
            if (!API_URL || !appState.currentUser || appState.currentUser.Role === 'Guest') return;
            
            const now = new Date();
            let newLogEntry = null;
            const payload = { 
                ...eventData,
                userId: appState.currentUser.UniqueID,
                userName: appState.currentUser.Name
            }; 

            if (payload.eventType === 'FinishQuiz') {
                const details = appState.currentQuiz.originalQuestions.map((q, index) => {
                    return {
                        qID: q.UniqueID,
                        ans: appState.currentQuiz.originalUserAnswers[index] ? appState.currentQuiz.originalUserAnswers[index].answer : 'No Answer'
                    };
                });
                payload.details = JSON.stringify(details);

                newLogEntry = {
                    logId: now.toISOString(),
                    timestamp: now,
                    eventType: 'FinishQuiz',
                    title: payload.quizTitle,
                    score: payload.score,
                    total: payload.totalQuestions,
                    isReviewable: true
                };
            }

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            }).then(() => {
                if (newLogEntry) {
                    appState.fullActivityLog.unshift(newLogEntry);
                }
            }).catch(error => console.error('Error logging activity:', error));
        }

        function parseQuestions(data) {
            if (!data) return [];
            return data.filter(row => row.Question && String(row.Question).trim()).map(row => {
                const answerOptions = [];
                if (row.CorrectAnswer && String(row.CorrectAnswer).trim() !== '') answerOptions.push({ text: String(row.CorrectAnswer), isCorrect: true, rationale: row.CorrectRationale || '' });
                if (row.IncorrectAnswer1 && String(row.IncorrectAnswer1).trim() !== '') answerOptions.push({ text: String(row.IncorrectAnswer1), isCorrect: false, rationale: row.IncorrectRationale1 || '' });
                if (row.IncorrectAnswer2 && String(row.IncorrectAnswer2).trim() !== '') answerOptions.push({ text: String(row.IncorrectAnswer2), isCorrect: false, rationale: row.IncorrectRationale2 || '' });
                if (row.IncorrectAnswer3 && String(row.IncorrectAnswer3).trim() !== '') answerOptions.push({ text: String(row.IncorrectAnswer3), isCorrect: false, rationale: row.IncorrectRationale3 || '' });
                return { 
                    UniqueID: row.UniqueID, 
                    chapter: (row.Chapter && String(row.Chapter).trim()) ? row.Chapter : 'Uncategorized', 
                    question: row.Question, 
                    hint: row.Hint || '', 
                    source: row.Source || '', 
                    ImageURL: row.ImageURL || '', 
                    answerOptions: answerOptions 
                };
            });
        }
        
        function groupLecturesByChapter(lectureData) {
            if (!lectureData) return {};
            const chapters = {};
            lectureData.forEach(row => {
                const chapterName = row.Chapter;
                if (!chapterName || String(chapterName).length < 2) return;
                if (!chapters[chapterName]) {
                    chapters[chapterName] = { topics: [], mock: null, icon: '' };
                }
                if (row.LectureName) {
                    chapters[chapterName].topics.push({ 
                        id: row.UniqueID,
                        name: row.LectureName, 
                        link: row.LectureURL
                    });
                }
                if (row['Mock Link'] && !chapters[chapterName].mock) {
                    chapters[chapterName].mock = { 
                        link: row['Mock Link'], 
                        name: row['Mock Name'] || 'Mock Exam'
                    };
                }
                if(row.ChapterIcon && !chapters[chapterName].icon) {
                    chapters[chapterName].icon = row.ChapterIcon;
                }
            });
            return chapters;
        }

        function parseOsceCases(data) {
            if (!data) return [];
            return data.filter(row => row.CaseID && row.Title).map(row => ({
                CaseID: row.CaseID,
                Title: row.Title,
                ImageURL: row.ImageURL,
                Hint: row.Hint,
                CaseDescription: row.CaseDescription,
                AudioURL: row.AudioURL,
                Chapter: row.Chapter,
                Source: row.Source
            }));
        }

        function parseOsceQuestions(data) {
            if (!data) return [];
            return data.filter(row => row.QuestionID && row.CaseID).map(row => {
                const answerOptions = [];
                 if (row.CorrectAnswer && String(row.CorrectAnswer).trim() !== '') answerOptions.push({ text: String(row.CorrectAnswer), isCorrect: true, rationale: row.CorrectRationale || '' });
                if (row.IncorrectAnswer1 && String(row.IncorrectAnswer1).trim() !== '') answerOptions.push({ text: String(row.IncorrectAnswer1), isCorrect: false, rationale: row.IncorrectRationale1 || '' });
                if (row.IncorrectAnswer2 && String(row.IncorrectAnswer2).trim() !== '') answerOptions.push({ text: String(row.IncorrectAnswer2), isCorrect: false, rationale: row.IncorrectRationale2 || '' });
                if (row.IncorrectAnswer3 && String(row.IncorrectAnswer3).trim() !== '') answerOptions.push({ text: String(row.IncorrectAnswer3), isCorrect: false, rationale: row.IncorrectRationale3 || '' });

                return {
                    QuestionID: row.QuestionID,
                    CaseID: row.CaseID,
                    QuestionType: row.QuestionType,
                    QuestionText: row.QuestionText,
                    EssayModelAnswer: row.EssayModelAnswer,
                    ImageURL: row.ImageURL,
                    AudioURL: row.AudioURL,
                    answerOptions: answerOptions
                };
            });
        }

        async function loadContentData() {
            loginLoader.classList.remove('hidden');
            loginLoadingText.classList.remove('hidden');
            try {
                const response = await fetch(`${API_URL}?request=contentData&t=${new Date().getTime()}`, {
                    method: 'GET',
                    mode: 'cors',
                    redirect: 'follow'
                });

                if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                appState.allQuestions = parseQuestions(data.questions);
                appState.groupedLectures = groupLecturesByChapter(data.lectures);
                appState.mcqBooks = data.books || [];
                appState.allAnnouncements = data.announcements || [];
                appState.allOsceCases = parseOsceCases(data.osceCases);
                appState.allOsceQuestions = parseOsceQuestions(data.osceQuestions);
                
                populateAllFilterOptions();
                renderLectures();
                
                loginLoader.classList.add('hidden');
                loginLoadingText.classList.add('hidden');
                
            } catch (error) {
                console.error("Error loading content data:", error);
                loginLoadingText.textContent = `Failed to load content. Please ensure the script is deployed correctly and refresh. Error: ${error.message}`;
            }
        }

        async function loadUserData() {
            if (!appState.currentUser || appState.currentUser.Role === 'Guest') return;
            try {
                const response = await fetch(`${API_URL}?request=userData&userId=${appState.currentUser.UniqueID}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Could not fetch user data.');
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                appState.fullActivityLog = data.logs || [];
                appState.userQuizNotes = data.quizNotes || [];
                appState.userLectureNotes = data.lectureNotes || [];
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function populateFilterOptions(containerElement, items, inputNamePrefix, counts) {
            containerElement.innerHTML = '';
            if (!items || items.length === 0) {
                containerElement.innerHTML = `<p class="text-slate-400 text-sm">No options available.</p>`;
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                const safeId = `${inputNamePrefix}-${item.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const count = counts[item] || 0;
                div.innerHTML = `<input id="${safeId}" name="${inputNamePrefix}" value="${item}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="${safeId}" class="ml-3 text-sm text-gray-600">${item} (${count} Qs)</label>`;
                containerElement.appendChild(div);
            });
        }

        function populateAllFilterOptions() {
            const sourceCounts = {};
            const chapterCounts = {};

            appState.allQuestions.forEach(q => {
                const source = q.source || 'Uncategorized';
                const chapter = q.chapter || 'Uncategorized';
                sourceCounts[source] = (sourceCounts[source] || 0) + 1;
                chapterCounts[chapter] = (chapterCounts[chapter] || 0) + 1;
            });

            const sortedSources = Object.keys(sourceCounts).sort();
            const sortedChapters = Object.keys(chapterCounts).sort();
            
            populateFilterOptions(sourceSelectMock, sortedSources, 'mock-source', sourceCounts);
            populateFilterOptions(chapterSelectMock, sortedChapters, 'mock-chapter', chapterCounts);
            
            const osceChapters = [...new Set(appState.allOsceCases.map(c => c.Chapter).filter(c => c))].sort();
            const osceSources = [...new Set(appState.allOsceCases.map(c => c.Source).filter(s => s))].sort();
            // We don't have counts for OSCE yet, so we pass an empty object
            populateFilterOptions(chapterSelectOsce, osceChapters, 'osce-chapter', {});
            populateFilterOptions(sourceSelectOsce, osceSources, 'osce-source', {});
        }
        
        function updateChapterFilter() {
            const selectedSources = [...sourceSelectMock.querySelectorAll('input:checked')].map(el => el.value);
            
            let relevantQuestions;
            if (selectedSources.length === 0) {
                relevantQuestions = appState.allQuestions;
            } else {
                relevantQuestions = appState.allQuestions.filter(q => selectedSources.includes(q.source || 'Uncategorized'));
            }

            const chapterCounts = {};
            relevantQuestions.forEach(q => {
                const chapter = q.chapter || 'Uncategorized';
                chapterCounts[chapter] = (chapterCounts[chapter] || 0) + 1;
            });

            const sortedChapters = Object.keys(chapterCounts).sort();
            populateFilterOptions(chapterSelectMock, sortedChapters, 'mock-chapter', chapterCounts);
        }

        async function handleLogin(event) {
            event.preventDefault();
            loginError.classList.add('hidden');
            loginSubmitBtn.disabled = true;
            loginSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Logging in...';

            const payload = {
                eventType: 'login',
                username: usernameInput.value,
                password: passwordInput.value
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify(payload),
                    redirect: 'follow' 
                });

                const result = await response.json();

                if (result.success) {
                    appState.currentUser = result.user;
                    updateWatermark(appState.currentUser);
                    loadUserProgress();
                    await loadUserData();
                    showMainMenuScreen();
                } else {
                    loginError.textContent = result.message || "Invalid username or password.";
                    loginError.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Login API Error:", error);
                loginError.textContent = "An error occurred. Please try again.";
                loginError.classList.remove('hidden');
            } finally {
                loginSubmitBtn.disabled = false;
                loginSubmitBtn.textContent = 'Log In';
            }
        }
        
        function showScreen(screenToShow, isGuest = false) {
            [loginContainer, mainMenuContainer, lecturesContainer, qbankContainer, listContainer, quizContainer, activityLogContainer, notesContainer, libraryContainer, leaderboardContainer, osceContainer, osceQuizContainer, learningModeContainer].forEach(screen => {
                if(screen) screen.classList.add('hidden');
            });
            if(screenToShow) screenToShow.classList.remove('hidden');

            const watermarkOverlay = document.getElementById('watermark-overlay');
            if (screenToShow !== loginContainer && !isGuest) {
                globalHeader.classList.remove('hidden');
                watermarkOverlay.classList.remove('hidden');
                if (isGuest) {
                    userNameDisplay.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                    activityLogBtn.classList.add('hidden');
                    notesBtn.classList.add('hidden');
                } else {
                    userNameDisplay.textContent = appState.currentUser.Name;
                    userNameDisplay.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                    activityLogBtn.classList.remove('hidden');
                    notesBtn.classList.remove('hidden');
                }
            } else {
                globalHeader.classList.add('hidden');
                watermarkOverlay.classList.add('hidden');
            }
        }

        async function showMainMenuScreen() {
            showScreen(mainMenuContainer);
            appState.navigationHistory = [showMainMenuScreen];
            displayAnnouncement();
            await fetchAndShowLastActivity();
        }
        
        function showLecturesScreen() {
            showScreen(lecturesContainer);
            appState.navigationHistory.push(showLecturesScreen);
            renderLectures();
        }

        function showQbankScreen() {
            showScreen(qbankContainer);
            appState.navigationHistory.push(showQbankScreen);
        }

        function showLibraryScreen() {
            showScreen(libraryContainer);
            appState.navigationHistory.push(showLibraryScreen);
            renderBooks();
        }

        async function showLeaderboardScreen() {
            showScreen(leaderboardContainer);
            appState.navigationHistory.push(showLeaderboardScreen);
            leaderboardList.innerHTML = '';
            currentUserRankDiv.innerHTML = '';
            leaderboardLoader.classList.remove('hidden');
            try {
                const response = await fetch(`${API_URL}?request=leaderboard&userId=${appState.currentUser.UniqueID}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Failed to fetch leaderboard data.');
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                renderLeaderboard(data.leaderboard, data.currentUserRank);
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                leaderboardList.innerHTML = `<p class="text-center text-red-500">${error.message}</p>`;
            } finally {
                leaderboardLoader.classList.add('hidden');
            }
        }

        function renderLeaderboard(top10, currentUserRank) {
            leaderboardList.innerHTML = '';
            currentUserRankDiv.innerHTML = '';

            if (currentUserRank) {
                currentUserRankDiv.innerHTML = `
                    <div class="p-4 bg-blue-100 border-2 border-blue-300 rounded-lg">
                        <h4 class="text-lg font-bold text-center text-blue-800">Your Rank</h4>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 flex items-center justify-center text-xl font-bold text-blue-700">${currentUserRank.rank}</div>
                                <p class="font-bold text-slate-800 text-lg ml-4">${currentUserRank.name} (You)</p>
                            </div>
                            <div class="text-right">
                                <p class="font-extrabold text-2xl text-blue-600">${currentUserRank.score}</p>
                                <p class="text-xs text-slate-500">Total Score</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (!top10 || top10.length === 0) {
                leaderboardList.innerHTML = `<p class="text-center text-slate-500 mt-4">The leaderboard is empty. Start a quiz to get on the board!</p>`;
                return;
            }

            top10.forEach(user => {
                const rank = user.rank;
                let rankIcon = '';
                let rankColor = 'bg-white border-slate-200';
                if (rank === 1) {
                    rankIcon = 'fas fa-trophy text-yellow-400';
                    rankColor = 'bg-yellow-100 border-yellow-300';
                } else if (rank === 2) {
                    rankIcon = 'fas fa-medal text-gray-400';
                    rankColor = 'bg-gray-100 border-gray-300';
                } else if (rank === 3) {
                    rankIcon = 'fas fa-award text-orange-400';
                    rankColor = 'bg-orange-100 border-orange-300';
                }

                const userElement = document.createElement('div');
                userElement.className = `flex items-center p-4 rounded-lg border-2 ${rankColor}`;
                
                userElement.innerHTML = `
                    <div class="w-10 h-10 flex items-center justify-center text-xl font-bold ${rank > 3 ? 'text-slate-600' : ''}">
                        ${rankIcon ? `<i class="${rankIcon}"></i>` : rank}
                    </div>
                    <div class="flex-grow ml-4">
                        <p class="font-bold text-slate-800 text-lg">${user.name}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-slate-500">Rank ${rank}</p>
                    </div>
                `;
                leaderboardList.appendChild(userElement);
            });
        }


        function renderBooks() {
            libraryList.innerHTML = '';
            if (appState.mcqBooks.length === 0) {
                libraryList.innerHTML = `<p class="text-center text-slate-500">No books found in the library.</p>`;
                return;
            }

            appState.mcqBooks.forEach(book => {
                if (!book.Book || !book.Link) return;
                const bookElement = document.createElement('a');
                bookElement.href = book.Link;
                bookElement.target = '_blank';
                bookElement.className = 'flex items-start p-4 bg-white rounded-lg border border-slate-200 shadow-sm hover:shadow-md hover:bg-slate-50 transition-all duration-200';

                // --- START: MODIFIED CODE ---
                let iconHtml;
                // Check if the icon field contains a valid URL
                if (book.icon && (book.icon.startsWith('http://') || book.icon.startsWith('https://'))) {
                    // If it's a URL, use an <img> tag
                    iconHtml = `<div class="flex-shrink-0 w-12 h-12 flex items-center justify-center bg-slate-100 rounded-lg mr-4 overflow-hidden">
                                    <img src="${book.icon}" alt="${book.Book}" class="w-full h-full object-cover">
                                </div>`;
                } else {
                    // Otherwise, use a Font Awesome icon (either from the sheet or a default one)
                    iconHtml = `<div class="flex-shrink-0 w-12 h-12 flex items-center justify-center bg-orange-100 rounded-lg mr-4">
                                    <i class="${book.icon || 'fas fa-book'} text-2xl text-orange-600"></i>
                                </div>`;
                }
                // --- END: MODIFIED CODE ---

                const contentHtml = `<div class="flex-grow">
                                         <h3 class="font-bold text-slate-800 text-lg">${book.Book}</h3>
                                         <p class="text-slate-600 text-sm mt-1">${book.Description || ''}</p>
                                     </div>`;

                const arrowHtml = `<div class="flex-shrink-0 ml-4 self-center">
                                       <i class="fas fa-external-link-alt text-slate-400"></i>
                                   </div>`;

                bookElement.innerHTML = iconHtml + contentHtml + arrowHtml;
                libraryList.appendChild(bookElement);
            });
        }
        
        function renderLectures(filterText = '') {
            lecturesList.innerHTML = '';
            const lowerCaseFilter = filterText.toLowerCase();
            const chapterNames = Object.keys(appState.groupedLectures).sort();
            let chaptersFound = 0;

            if (Object.keys(appState.groupedLectures).length === 0) {
                lecturesLoader.classList.remove('hidden');
                return;
            }
            lecturesLoader.classList.add('hidden');

            chapterNames.forEach(chapterName => {
                const chapterData = appState.groupedLectures[chapterName];
                const isChapterMatch = chapterName.toLowerCase().includes(lowerCaseFilter);
                const isTopicMatch = chapterData.topics.some(topic => topic.name.toLowerCase().includes(lowerCaseFilter));
                if (filterText && !isChapterMatch && !isTopicMatch) return;
                chaptersFound++;
                const details = document.createElement('details');
                details.className = 'bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm';
                details.open = !!filterText;
                const summary = document.createElement('summary');
                summary.className = 'p-4 cursor-pointer hover:bg-slate-50';
                
                const totalTopics = chapterData.topics.length;
                const viewedTopics = chapterData.topics.filter(topic => appState.viewedLectures.has(topic.link)).length;
                const progressPercentage = totalTopics > 0 ? (viewedTopics / totalTopics) * 100 : 0;

                summary.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="flex items-center font-bold text-slate-800 text-lg">
                            <i class="${chapterData.icon || 'fas fa-layer-group'} mr-3 text-cyan-600 w-5 text-center"></i>
                            ${chapterName}
                        </span>
                        <div class="flex items-center gap-4">
                            <i class="fas fa-chevron-down transition-transform duration-300 text-slate-500"></i>
                        </div>
                    </div>
                    <div class="mt-2 flex items-center gap-2">
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
                        </div>
                        <span class="text-xs font-semibold text-slate-500">${viewedTopics}/${totalTopics}</span>
                    </div>
                `;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'p-4 bg-slate-50 border-t border-slate-200';
                const topicList = document.createElement('ul');
                topicList.className = 'space-y-2';
                chapterData.topics.forEach(topic => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between p-3 rounded-md hover:bg-blue-100 transition-colors group';
                    const isViewed = appState.viewedLectures.has(topic.link);
                    
                    if (isViewed) {
                        listItem.classList.add('lecture-viewed');
                    }

                    const controls = document.createElement('div');
                    controls.className = 'flex items-center gap-3';

                    const icon = document.createElement('i');
                    icon.className = `fas ${isViewed ? 'fa-check-circle' : 'fa-play-circle'} mr-3 text-blue-500 view-toggle-icon`;
                    icon.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleLectureViewed(topic.link, topic.name);
                    });

                    const noteIcon = document.createElement('i');
                    const hasNote = appState.userLectureNotes.some(note => note.LectureID === topic.id);
                    noteIcon.className = `fas fa-sticky-note text-slate-400 hover:text-amber-500 note-icon ${hasNote ? 'has-note' : ''}`;
                    noteIcon.addEventListener('click', (e) => {
                         e.preventDefault();
                         e.stopPropagation();
                         openNoteModal('lecture', topic.id, topic.name);
                    });
                    
                    controls.appendChild(icon);
                    controls.appendChild(noteIcon);
                    
                    const content = document.createElement('div');
                    content.className = "flex-grow";

                    if (topic.link) {
                        const link = document.createElement('a');
                        link.href = topic.link;
                        link.target = '_blank';
                        link.className = "lecture-name text-slate-800 font-medium";
                        link.textContent = topic.name;
                        content.appendChild(link);
                    } else {
                        const nameSpan = document.createElement('span');
                        nameSpan.className = "lecture-name text-slate-500";
                        nameSpan.textContent = topic.name;
                        content.appendChild(nameSpan);
                    }
                    
                    listItem.appendChild(controls);
                    listItem.appendChild(content);
                    
                    topicList.appendChild(listItem);
                });
                contentDiv.appendChild(topicList);
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'mt-4 pt-4 border-t border-slate-200 flex flex-col sm:flex-row gap-3';
                const relevantQuestions = appState.allQuestions.filter(q => q.chapter.trim().toLowerCase() === chapterName.trim().toLowerCase());
                if (relevantQuestions.length > 0) {
                    const quizButton = document.createElement('button');
                    quizButton.className = 'w-full action-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2';
                    quizButton.innerHTML = `<i class="fas fa-pencil-alt"></i> Test Chapter (${relevantQuestions.length} Qs)`;
                    quizButton.addEventListener('click', () => startChapterQuiz(chapterName, relevantQuestions));
                    actionsDiv.appendChild(quizButton);
                }
                if (chapterData.mock && chapterData.mock.link) {
                    const mockButton = document.createElement('a');
                    mockButton.href = chapterData.mock.link;
                    mockButton.target = '_blank';
                    mockButton.className = 'w-full action-btn bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2';
                    mockButton.innerHTML = `<i class="fas fa-vial"></i> ${chapterData.mock.name}`;
                    actionsDiv.appendChild(mockButton);
                }
                if(actionsDiv.hasChildNodes()){
                    contentDiv.appendChild(actionsDiv);
                }
                details.appendChild(summary);
                details.appendChild(contentDiv);
                lecturesList.appendChild(details);
            });
            if (chaptersFound === 0) {
                 lecturesList.innerHTML = `<p class="text-center text-slate-500">No lectures found matching your search.</p>`;
            }
        }

        function toggleLectureViewed(lectureLink, lectureName) {
            if (appState.viewedLectures.has(lectureLink)) {
                appState.viewedLectures.delete(lectureLink);
            } else {
                appState.viewedLectures.add(lectureLink);
                logUserActivity({
                    eventType: 'ViewLecture',
                    lectureName: lectureName 
                });
            }
            saveUserProgress();
            renderLectures(lectureSearchInput.value);
        }

        function saveUserProgress() {
            if (!appState.currentUser || appState.currentUser.Role === 'Guest') return;
            localStorage.setItem(`viewedLectures_${appState.currentUser.UniqueID}`, JSON.stringify(Array.from(appState.viewedLectures)));
            localStorage.setItem(`bookmarkedQuestions_${appState.currentUser.UniqueID}`, JSON.stringify(Array.from(appState.bookmarkedQuestions)));
        }

        function loadUserProgress() {
            if (!appState.currentUser || appState.currentUser.Role === 'Guest') return;
            const savedLectures = localStorage.getItem(`viewedLectures_${appState.currentUser.UniqueID}`);
            if (savedLectures) {
                appState.viewedLectures = new Set(JSON.parse(savedLectures));
            }
            const savedBookmarks = localStorage.getItem(`bookmarkedQuestions_${appState.currentUser.UniqueID}`);
            if (savedBookmarks) {
                appState.bookmarkedQuestions = new Set(JSON.parse(savedBookmarks));
            }
        }

        async function fetchAndShowLastActivity() {
            if (!appState.currentUser || appState.currentUser.Role === 'Guest') return;
            lastLectureRibbon.classList.add('hidden');
            lastQuizRibbon.classList.add('hidden');
            
            if (appState.fullActivityLog.length === 0) return;

            const lastLecture = appState.fullActivityLog.find(log => log.eventType === 'ViewLecture');
            const lastQuiz = appState.fullActivityLog.find(log => log.eventType === 'FinishQuiz');

            if (lastLecture) {
                lastLectureRibbon.innerHTML = `<i class="fas fa-video mr-2"></i> Last Lecture Viewed: <strong>${lastLecture.title}</strong>`;
                lastLectureRibbon.classList.remove('hidden');
            }
            if (lastQuiz) {
                lastQuizRibbon.innerHTML = `<i class="fas fa-check-double mr-2"></i> Last Quiz: <strong>${lastQuiz.title}</strong> (Score: ${lastQuiz.score}/${lastQuiz.total})`;
                lastQuizRibbon.classList.remove('hidden');
            }
        }

        async function showActivityLog() {
            showScreen(activityLogContainer);
            appState.navigationHistory.push(showActivityLog);
            activityLogList.innerHTML = '<div class="loader"></div>';
            await loadUserData();
            renderFilteredLog('all');
        }

        function renderFilteredLog(filter) {
            activityLogList.innerHTML = '';
            document.querySelectorAll('#activity-log-container .filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`log-filter-${filter}`).classList.add('active');

            allSummary.classList.add('hidden');
            quizSummary.classList.add('hidden');
            lectureSummary.classList.add('hidden');

            const logsToDisplay = appState.fullActivityLog.filter(log => {
                if (filter === 'all') return true;
                if (filter === 'quizzes') return log.eventType === 'FinishQuiz';
                if (filter === 'lectures') return log.eventType === 'ViewLecture';
                return false;
            });
            
            renderActivityChart(logsToDisplay);

            const quizLogs = appState.fullActivityLog.filter(log => log.eventType === 'FinishQuiz');
            let totalCorrect = 0;
            let totalAttemptedInQuizzes = 0;

            quizLogs.forEach(log => {
                const score = parseInt(log.score, 10) || 0;
                const total = parseInt(log.total, 10) || 0;
                totalCorrect += score;
                totalAttemptedInQuizzes += total;
            });
            const totalIncorrect = totalAttemptedInQuizzes - totalCorrect;

            if (filter === 'all') {
                allSummary.classList.remove('hidden');
                const totalLecturesInSystem = Object.values(appState.groupedLectures).reduce((acc, chapter) => acc + chapter.topics.length, 0);
                const viewedLectureCount = new Set(appState.fullActivityLog.filter(l => l.eventType === 'ViewLecture').map(l => l.title)).size;
                allLecturesProgress.textContent = `${viewedLectureCount} / ${totalLecturesInSystem}`;
                allQuestionsProgress.textContent = `${totalAttemptedInQuizzes} / ${appState.allQuestions.length}`;

            } else if (filter === 'quizzes') {
                quizSummary.classList.remove('hidden');
                totalCorrectAnswers.textContent = totalCorrect;
                totalIncorrectAnswers.textContent = totalIncorrect;
                const accuracy = totalAttemptedInQuizzes > 0 ? ((totalCorrect / totalAttemptedInQuizzes) * 100).toFixed(1) : 0;
                overallAccuracy.textContent = `${accuracy}%`;
            } else if (filter === 'lectures') {
                lectureSummary.classList.remove('hidden');
                const viewedLogs = appState.fullActivityLog.filter(log => log.eventType === 'ViewLecture');
                const uniqueViewedLectures = new Set(viewedLogs.map(l => l.title));
                lecturesViewedCount.textContent = uniqueViewedLectures.size;
                
                const uniqueChapters = new Set();
                viewedLogs.forEach(log => {
                    for (const chapterName in appState.groupedLectures) {
                        if (appState.groupedLectures[chapterName].topics.some(t => t.name === log.title)) {
                            uniqueChapters.add(chapterName);
                            break;
                        }
                    }
                });
                chaptersStartedCount.textContent = uniqueChapters.size;
            }


            if (logsToDisplay.length === 0) {
                activityLogList.innerHTML = `<p class="text-center text-slate-500">No activity recorded for this filter.</p>`;
                return;
            }

            logsToDisplay.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'p-3 border rounded-lg flex flex-col sm:flex-row justify-between items-center bg-white gap-3';
                const date = new Date(log.timestamp);
                const formattedDate = date.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute:'2-digit' });

                let mainContent = '';
                if (log.eventType === 'FinishQuiz') {
                    mainContent = `
                        <div class="flex-grow text-center sm:text-left">
                            <p class="font-bold text-slate-800">${log.title}</p>
                            <p class="text-sm text-slate-500">${formattedDate}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg ${log.score / log.total >= 0.5 ? 'text-green-600' : 'text-red-600'}">
                                ${log.score} / ${log.total}
                            </p>
                            <p class="text-xs text-slate-500">Score</p>
                        </div>
                    `;
                    if (log.isReviewable) {
                        const reviewButton = document.createElement('button');
                        reviewButton.innerHTML = `<i class="fas fa-redo-alt mr-2"></i> Review`;
                        reviewButton.className = 'action-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm';
                        reviewButton.onclick = () => startFullQuizReview(log.logId, log.title);
                        logItem.appendChild(reviewButton);
                    }
                } else if (log.eventType === 'ViewLecture') {
                       mainContent = `
                        <div class="flex-grow text-center sm:text-left">
                            <p class="font-bold text-slate-800">${log.title}</p>
                            <p class="text-sm text-slate-500">${formattedDate}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-green-600"><i class="fas fa-video"></i></p>
                            <p class="text-xs text-slate-500">Viewed</p>
                        </div>
                    `;
                }
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'flex-grow flex items-center justify-between w-full';
                contentWrapper.innerHTML = mainContent;
                logItem.prepend(contentWrapper);
                activityLogList.appendChild(logItem);
            });
        }

        function renderActivityChart(logs) {
            if (appState.activityChartInstance) {
                appState.activityChartInstance.destroy();
            }
            const labels = [];
            const activityByDay = {};

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0]; // YYYY-MM-DD
                labels.push(d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric'}));
                activityByDay[key] = { lectures: 0, quizzes: 0 };
            }

            logs.forEach(log => {
                const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                if (activityByDay.hasOwnProperty(logDate)) {
                    if (log.eventType === 'ViewLecture') {
                        activityByDay[logDate].lectures++;
                    } else if (log.eventType === 'FinishQuiz') {
                        activityByDay[logDate].quizzes++;
                    }
                }
            });

            const lectureData = Object.values(activityByDay).map(d => d.lectures);
            const quizData = Object.values(activityByDay).map(d => d.quizzes);

            appState.activityChartInstance = new Chart(activityChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Lectures',
                            data: lectureData,
                            backgroundColor: 'rgba(20, 184, 166, 0.6)',
                            borderColor: 'rgb(13, 148, 136)',
                            borderWidth: 1
                        },
                        {
                            label: 'Quizzes',
                            data: quizData,
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: 'rgb(37, 99, 235)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: 'Your Activity in the Last 7 Days' }
                    }
                }
            });
        }

        function showSourceList(isLearningMode = false) {
            showScreen(listContainer);
            
            if (appState.navigationHistory[appState.navigationHistory.length - 1] !== showSourceList) {
               appState.navigationHistory.push(() => showSourceList(isLearningMode));
            }

            listTitle.textContent = isLearningMode ? "Study by Source" : "Browse by Source";
            listItems.innerHTML = '';
            const sourceGroups = new Map();
            appState.allQuestions.forEach(q => {
                const sourceName = (q.source && q.source.trim()) ? q.source.trim() : "Uncategorized";
                const normalizedKey = sourceName.toLowerCase();
                if (sourceGroups.has(normalizedKey)) {
                    sourceGroups.get(normalizedKey).count++;
                } else {
                    sourceGroups.set(normalizedKey, { displayName: sourceName, count: 1 });
                }
            });
            const sortedSources = [...sourceGroups.values()].sort((a, b) => a.displayName.localeCompare(b.displayName));
            sortedSources.forEach(sourceGroup => {
                const button = document.createElement('button');
                button.innerHTML = `<span>${sourceGroup.displayName}</span> <span class="text-xs font-normal opacity-75">(${sourceGroup.count} Qs)</span>`;
                button.className = 'action-btn w-full p-4 rounded-lg bg-indigo-600 text-white font-semibold text-lg hover:bg-indigo-700 flex flex-col items-center justify-center text-center';
                button.addEventListener('click', () => showChapterList(sourceGroup.displayName, isLearningMode));
                listItems.appendChild(button);
            });
        }

        function showChapterList(sourceFilter = 'All', isLearningMode = false) {
            showScreen(listContainer);
            
            const prevNav = appState.navigationHistory[appState.navigationHistory.length - 1];
            if (!prevNav || prevNav.toString() !== (() => showChapterList(sourceFilter, isLearningMode)).toString()) {
                appState.navigationHistory.push(() => showChapterList(sourceFilter, isLearningMode));
            }

            listTitle.textContent = sourceFilter === 'All' 
                ? (isLearningMode ? "Select Chapters to Study" : "All Chapters") 
                : (isLearningMode ? `Select Chapters from ${sourceFilter}`: `Chapters in ${sourceFilter}`);
            
            listItems.innerHTML = '';
            
            if (isLearningMode) {
                listItems.className = 'p-4 md:p-6 space-y-3'; 
            } else {
                listItems.className = 'p-4 md:p-6 grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4';
            }

            const questionsToDisplay = (sourceFilter === 'All') ? appState.allQuestions : appState.allQuestions.filter(q => q.source === sourceFilter);
            const chapters = {};
            questionsToDisplay.forEach(q => {
                if (!chapters[q.chapter]) chapters[q.chapter] = [];
                chapters[q.chapter].push(q);
            });
            const sortedChapterNames = Object.keys(chapters).sort();

            if (isLearningMode) {
                // --- Learning Mode: Checkbox List ---
                const selectAllContainer = document.createElement('div');
                selectAllContainer.className = 'flex items-center p-2 border-b';
                selectAllContainer.innerHTML = `
                    <input id="select-all-chapters" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="select-all-chapters" class="ml-3 font-bold text-gray-700">Select All</label>
                `;
                listItems.appendChild(selectAllContainer);

                const chapterListContainer = document.createElement('div');
                chapterListContainer.className = 'max-h-96 overflow-y-auto space-y-2 p-2';
                listItems.appendChild(chapterListContainer);

                sortedChapterNames.forEach(chapterName => {
                    const chapterId = `learn-chapter-${chapterName.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input id="${chapterId}" name="learning-chapter" value="${chapterName}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="${chapterId}" class="ml-3 text-sm text-gray-600">${chapterName} (${chapters[chapterName].length} Qs)</label>
                    `;
                    chapterListContainer.appendChild(div);
                });

                const startButton = document.createElement('button');
                startButton.id = 'start-learning-selection-btn';
                startButton.className = 'action-btn w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg';
                startButton.textContent = 'Start Learning Session';
                listItems.appendChild(startButton);
                
                const errorP = document.createElement('p');
                errorP.id = 'learning-selection-error';
                errorP.className = 'text-red-500 text-xs italic mt-2 text-center hidden';
                listItems.appendChild(errorP);

                document.getElementById('select-all-chapters').addEventListener('change', (e) => {
                    listItems.querySelectorAll('input[name="learning-chapter"]').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });

                startButton.addEventListener('click', () => {
                    const selectedChapters = [...listItems.querySelectorAll('input[name="learning-chapter"]:checked')].map(el => el.value);
                    
                    if (selectedChapters.length === 0) {
                        errorP.textContent = 'Please select at least one chapter to study.';
                        errorP.classList.remove('hidden');
                        return;
                    }
                    
                    errorP.classList.add('hidden');

                    let questionsToLearn = [];
                    selectedChapters.forEach(chapterName => {
                        questionsToLearn.push(...chapters[chapterName]);
                    });

                    const title = selectedChapters.length > 1 ? 'Multiple Chapters' : selectedChapters[0];
                    launchLearningMode(title, questionsToLearn);
                });

            } else {
                // --- Quiz Mode: Original Button Logic ---
                sortedChapterNames.forEach(chapterName => {
                    const button = document.createElement('button');
                    button.innerHTML = `<span>${chapterName}</span> <span class="text-xs font-normal opacity-75">(${chapters[chapterName].length} Qs)</span>`;
                    button.className = 'action-btn w-full p-4 rounded-lg bg-blue-600 text-white font-semibold text-lg hover:bg-blue-700 flex flex-col items-center justify-center text-center';
                    button.addEventListener('click', () => startChapterQuiz(chapterName, chapters[chapterName]));
                    listItems.appendChild(button);
                });
            }
        }

        function startChapterQuiz(chapterName, questionsToUse) {
            const shuffled = [...questionsToUse].sort(() => Math.random() - 0.5);
            launchQuiz(shuffled, chapterName);
        }

        function handleMockExamStart() {
            mockError.classList.add('hidden');
            const requestedCount = parseInt(mockQCountInput.value, 10);
            if (isNaN(requestedCount) || requestedCount <= 0) {
                mockError.textContent = "Please enter a valid number of questions.";
                mockError.classList.remove('hidden');
                return;
            }
            const customTime = parseInt(customTimerInput.value, 10);
            const selectedChapters = [...chapterSelectMock.querySelectorAll('input:checked')].map(el => el.value);
            const selectedSources = [...sourceSelectMock.querySelectorAll('input:checked')].map(el => el.value);
            let filteredQuestions = appState.allQuestions;
            if (selectedChapters.length > 0) filteredQuestions = filteredQuestions.filter(q => selectedChapters.includes(q.chapter));
            if (selectedSources.length > 0) filteredQuestions = filteredQuestions.filter(q => selectedSources.includes(q.source));
            if (filteredQuestions.length === 0) {
                mockError.textContent = "No questions match the selected filters.";
                mockError.classList.remove('hidden');
                return;
            }
            if (requestedCount > filteredQuestions.length) {
                mockError.textContent = `Only ${filteredQuestions.length} questions match your filters.`;
                mockError.classList.remove('hidden');
                return;
            }
            const shuffled = [...filteredQuestions].sort(() => Math.random() - 0.5);
            const mockQuestions = shuffled.slice(0, requestedCount);
            
            const config = {
                timePerQuestion: (customTime && customTime > 0) ? customTime : DEFAULT_TIME_PER_QUESTION
            };
            launchQuiz(mockQuestions, "Custom Mock Exam", config);
        }

        function handleStartSimulation() {
            simulationError.classList.add('hidden');
            if (appState.allQuestions.length < SIMULATION_Q_COUNT) {
                simulationError.textContent = `Not enough questions available for a full simulation. (Required: ${SIMULATION_Q_COUNT}, Available: ${appState.allQuestions.length})`;
                simulationError.classList.remove('hidden');
                return;
            }

            const shuffled = [...appState.allQuestions].sort(() => Math.random() - 0.5);
            const simulationQuestions = shuffled.slice(0, SIMULATION_Q_COUNT);
            const totalTimeSeconds = SIMULATION_TOTAL_TIME_MINUTES * 60;
            
            const config = {
                isSimulation: true,
                totalTimeSeconds: totalTimeSeconds
            };

            launchQuiz(simulationQuestions, "Exam Simulation", config);
        }

        function startSimulationTimer(durationInSeconds) {
            clearInterval(appState.currentQuiz.simulationTimerInterval);
            let timeLeft = durationInSeconds;
            timerDisplay.textContent = formatTime(timeLeft);
            appState.currentQuiz.simulationTimerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(appState.currentQuiz.simulationTimerInterval);
                    triggerEndQuiz(true); // Force end due to time up
                }
            }, 1000);
        }

        function launchQuiz(questions, title, config = {}) {
            const {
                timePerQuestion = DEFAULT_TIME_PER_QUESTION,
                isReview = false,
                isMistakePractice = false,
                isSimulation = false,
                totalTimeSeconds = 0,
                pastAnswers = null
            } = config;

            appState.currentQuiz.isReviewMode = isReview;
            appState.currentQuiz.isPracticingMistakes = isMistakePractice;
            appState.currentQuiz.isSimulationMode = isSimulation;

            showScreen(quizContainer);
            appState.currentQuiz.currentQuestionIndex = 0;
            appState.currentQuiz.score = 0;
            appState.currentQuiz.questions = questions;
            
            if (!appState.currentQuiz.isReviewMode) {
                appState.currentQuiz.originalQuestions = [...questions];
                appState.currentQuiz.userAnswers = new Array(questions.length).fill(null);
                appState.currentQuiz.originalUserAnswers = appState.currentQuiz.userAnswers;
            } else {
                appState.currentQuiz.originalQuestions = [...questions];
                appState.currentQuiz.userAnswers = pastAnswers;
                appState.currentQuiz.originalUserAnswers = pastAnswers;
            }

            appState.currentQuiz.flaggedIndices.clear();
            resultsContainer.classList.add('hidden');
            questionContainer.classList.remove('hidden');
            controlsContainer.classList.remove('hidden');
            quizTitle.textContent = appState.currentQuiz.isReviewMode ? `Review: ${title}` : title;
            totalQuestionsSpan.textContent = appState.currentQuiz.questions.length;

            if (isSimulation) {
                startSimulationTimer(totalTimeSeconds);
            } else {
                appState.currentQuiz.timePerQuestion = timePerQuestion;
            }

            updateScoreBar();
            showQuestion();
        }

        function updateScoreBar() {
            const totalQuestions = appState.currentQuiz.questions.length;
            if (totalQuestions === 0) return;
            const answeredQuestions = appState.currentQuiz.userAnswers.filter(a => a !== null).length;
            const correctCount = appState.currentQuiz.userAnswers.filter(a => a && a.isCorrect).length;
            const incorrectCount = answeredQuestions - correctCount;
            scoreProgressText.textContent = `Score: ${correctCount} / ${answeredQuestions}`;
            scoreBarCorrect.style.width = `${(correctCount / totalQuestions) * 100}%`;
            scoreBarIncorrect.style.width = `${(incorrectCount / totalQuestions) * 100}%`;
        }

        function showQuestion() {
            resetQuizState();
            const currentQuestion = appState.currentQuiz.questions[appState.currentQuiz.currentQuestionIndex];
            
            hintBtn.style.display = appState.currentQuiz.isSimulationMode ? 'none' : 'block';

            if (currentQuestion.ImageURL) {
                const img = document.createElement('img');
                img.src = currentQuestion.ImageURL;
                img.alt = 'Question Image';
                img.className = 'max-h-48 rounded-lg mx-auto mb-4 cursor-pointer hover:opacity-80 transition-opacity';
                img.addEventListener('click', () => showImageModal(currentQuestion.ImageURL));
                questionImageContainer.appendChild(img);
            }

            questionText.textContent = currentQuestion.question;
            progressText.textContent = `Question ${appState.currentQuiz.currentQuestionIndex + 1} of ${appState.currentQuiz.questions.length}`;
            sourceText.textContent = `Source: ${currentQuestion.source || 'N/A'} | Chapter: ${currentQuestion.chapter || 'N/A'}`;
            previousBtn.disabled = appState.currentQuiz.currentQuestionIndex === 0;
            previousBtn.classList.toggle('opacity-50', appState.currentQuiz.currentQuestionIndex === 0);
            
            const isLastQuestion = appState.currentQuiz.currentQuestionIndex === appState.currentQuiz.questions.length - 1;

            if (appState.currentQuiz.isReviewMode && isLastQuestion) {
                nextSkipBtn.textContent = 'Finish Review';
            } else if (appState.currentQuiz.isSimulationMode && isLastQuestion) {
                 nextSkipBtn.textContent = 'Finish';
            } else {
                nextSkipBtn.textContent = 'Next';
            }
            
            flagBtn.classList.toggle('flagged', appState.currentQuiz.flaggedIndices.has(appState.currentQuiz.currentQuestionIndex));
            
            const shuffledAnswers = (appState.currentQuiz.isReviewMode || appState.currentQuiz.isSimulationMode) ? [...currentQuestion.answerOptions] : [...currentQuestion.answerOptions].sort(() => Math.random() - 0.5);
            
            shuffledAnswers.forEach(answer => {
                const buttonContainer = document.createElement('div');
                const button = document.createElement('button');
                button.textContent = answer.text;
                button.className = 'answer-btn w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-slate-200 border-2 border-transparent';
                button.dataset.correct = answer.isCorrect;
                button.dataset.text = answer.text;
                button.addEventListener('click', (e) => selectAnswer(e, answer));
                const rationale = document.createElement('p');
                rationale.textContent = answer.rationale;
                rationale.className = 'rationale text-sm mt-2 p-2 rounded-md';
                buttonContainer.appendChild(button);
                buttonContainer.appendChild(rationale);
                answerButtons.appendChild(buttonContainer);
            });

            const userAnswer = appState.currentQuiz.userAnswers[appState.currentQuiz.currentQuestionIndex];
            if (userAnswer !== null) {
                if (appState.currentQuiz.isSimulationMode) {
                    const selectedButton = Array.from(answerButtons.querySelectorAll('button')).find(btn => btn.dataset.text === userAnswer.answer);
                    if (selectedButton) {
                        selectedButton.classList.add('bg-blue-200', 'border-blue-400', 'user-choice');
                    }
                    answerButtons.querySelectorAll('button').forEach(btn => btn.disabled = true);
                } else {
                    showAnswerResult();
                }
            }
            
            if (!appState.currentQuiz.isReviewMode && !appState.currentQuiz.isSimulationMode) {
                startTimer();
            } else if (appState.currentQuiz.isReviewMode) {
                timerDisplay.textContent = 'Review';
            }
            
            const hasNote = appState.userQuizNotes.some(note => note.QuizID === currentQuestion.UniqueID);
            quizNoteBtn.classList.toggle('has-note', hasNote);
        }

        function startTimer() {
            if (appState.currentQuiz.userAnswers[appState.currentQuiz.currentQuestionIndex] === null) {
                let timeLeft = appState.currentQuiz.timePerQuestion;
                timerDisplay.textContent = formatTime(timeLeft);
                appState.currentQuiz.timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = formatTime(timeLeft);
                    if (timeLeft <= 0) {
                        clearInterval(appState.currentQuiz.timerInterval);
                        handleTimeUp();
                    }
                }, 1000);
            } else {
                timerDisplay.textContent = 'Done';
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function handleTimeUp() {
            appState.currentQuiz.userAnswers[appState.currentQuiz.currentQuestionIndex] = { answer: 'No Answer', isCorrect: false };
            showAnswerResult();
            updateScoreBar();
        }

        function resetQuizState() {
            clearInterval(appState.currentQuiz.timerInterval);
            answerButtons.innerHTML = '';
            questionImageContainer.innerHTML = '';
            hintText.classList.add('hidden');
        }

        function selectAnswer(e, selectedAnswer) {
            if (appState.currentQuiz.userAnswers[appState.currentQuiz.currentQuestionIndex] !== null) return;

            clearInterval(appState.currentQuiz.timerInterval);
            const currentQuestion = appState.currentQuiz.questions[appState.currentQuiz.currentQuestionIndex];

            const isCorrect = selectedAnswer.isCorrect;
            appState.currentQuiz.userAnswers[appState.currentQuiz.currentQuestionIndex] = { answer: selectedAnswer.text, isCorrect: isCorrect };

            if (isCorrect) {
                appState.currentQuiz.score++;
                if (appState.currentQuiz.isPracticingMistakes) {
                    logCorrectedMistake(currentQuestion.UniqueID);
                }
            } else if (!appState.currentQuiz.isPracticingMistakes && !appState.currentQuiz.isSimulationMode) {
                logIncorrectAnswer(currentQuestion.UniqueID, selectedAnswer.text);
            }

            if (appState.currentQuiz.isSimulationMode) {
                Array.from(answerButtons.querySelectorAll('button')).forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.text === selectedAnswer.text) {
                        btn.classList.add('bg-blue-200', 'border-blue-400', 'user-choice');
                    }
                });
                updateScoreBar();
            } else {
                showAnswerResult();
                updateScoreBar();
                if (appState.currentQuiz.userAnswers.every(answer => answer !== null)) {
                    setTimeout(showResults, 1000);
                }
            }
        }
        
        function showAnswerResult() {
            const userAnswer = appState.currentQuiz.userAnswers[appState.currentQuiz.currentQuestionIndex];
            Array.from(answerButtons.children).forEach(buttonContainer => {
                const button = buttonContainer.querySelector('button');
                const rationale = buttonContainer.querySelector('p');
                button.disabled = true;

                if (button.dataset.correct === 'true') {
                    button.classList.add('correct');
                    rationale.classList.add('bg-green-100', 'visible');
                } else {
                    if (userAnswer && button.dataset.text === userAnswer.answer) {
                        button.classList.add('incorrect', 'user-choice');
                    } else {
                         button.classList.add('incorrect');
                    }
                    rationale.classList.add('bg-red-100', 'visible');
                }
            });
            hintBtn.classList.add('hidden');
        }

        function showResults() {
            clearInterval(appState.currentQuiz.timerInterval);
            clearInterval(appState.currentQuiz.simulationTimerInterval); // Stop simulation timer

            questionContainer.classList.add('hidden');
            controlsContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');

            const resultTitle = appState.currentQuiz.isSimulationMode ? "Simulation Complete!" : "Quiz Complete!";
            resultsTitle.textContent = resultTitle;

            resultsScoreText.innerHTML = `Your score is <span id="score-text" class="font-bold">${appState.currentQuiz.score}</span> out of <span id="total-questions" class="font-bold">${appState.currentQuiz.originalQuestions.length}</span>.`;
            
            const incorrectCount = appState.currentQuiz.originalUserAnswers.filter(a => a && !a.isCorrect).length;
            if (incorrectCount > 0) {
                reviewIncorrectBtn.classList.remove('hidden');
                reviewIncorrectBtn.textContent = `Review ${incorrectCount} Incorrect`;
            } else {
                reviewIncorrectBtn.classList.add('hidden');
            }

            if (!appState.currentQuiz.isReviewMode && !appState.currentQuiz.isPracticingMistakes) {
                logUserActivity({
                    eventType: 'FinishQuiz',
                    quizTitle: quizTitle.textContent,
                    score: appState.currentQuiz.score,
                    totalQuestions: appState.currentQuiz.originalQuestions.length
                });

                if (appState.currentQuiz.isSimulationMode) {
                    appState.currentQuiz.originalQuestions.forEach((q, index) => {
                        const answer = appState.currentQuiz.originalUserAnswers[index];
                        if (answer && !answer.isCorrect) {
                            logIncorrectAnswer(q.UniqueID, answer.answer);
                        }
                    });
                }
            }
        }

        function handleNextQuestion() {
            if (appState.currentQuiz.isSimulationMode && appState.currentQuiz.currentQuestionIndex === appState.currentQuiz.questions.length - 1) {
                triggerEndQuiz(true);
                return;
            }

            if (appState.currentQuiz.currentQuestionIndex < appState.currentQuiz.questions.length - 1) {
                appState.currentQuiz.currentQuestionIndex++;
                showQuestion();
            } else if (appState.currentQuiz.isReviewMode) {
                showResults();
            }
        }
        
        function handlePreviousQuestion() {
            if (appState.currentQuiz.currentQuestionIndex > 0) {
                appState.currentQuiz.currentQuestionIndex--;
                showQuestion();
            }
        }

        function toggleFlag() {
            const index = appState.currentQuiz.currentQuestionIndex;
            appState.currentQuiz.flaggedIndices.has(index) ? appState.currentQuiz.flaggedIndices.delete(index) : appState.currentQuiz.flaggedIndices.add(index);
            flagBtn.classList.toggle('flagged');
        }

        function showImageModal(src) {
            modalImage.src = src;
            confirmationModal.classList.add('hidden');
            questionNavigatorModal.classList.add('hidden');
            imageViewerModal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
        }

        function showConfirmationModal(title, text, onConfirm) {
            appState.modalConfirmAction = onConfirm;
            confirmationModal.querySelector('#modal-title').textContent = title;
            confirmationModal.querySelector('#modal-text').textContent = text;
            questionNavigatorModal.classList.add('hidden');
            imageViewerModal.classList.add('hidden');
            confirmationModal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
        }

        function showQuestionNavigator() {
            navigatorGrid.innerHTML = '';
            appState.currentQuiz.questions.forEach((_, index) => {
                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'navigator-btn w-10 h-10 rounded-md font-semibold flex items-center justify-center';
                const answer = appState.currentQuiz.userAnswers[index];
                if (answer === null) button.classList.add('unanswered');
                else if (answer.isCorrect) button.classList.add('correct');
                else button.classList.add('incorrect');
                if (appState.currentQuiz.flaggedIndices.has(index)) {
                    const flagIcon = document.createElement('i');
                    flagIcon.className = 'fas fa-flag flag-icon';
                    button.appendChild(flagIcon);
                }
                button.addEventListener('click', () => {
                    appState.currentQuiz.currentQuestionIndex = index;
                    showQuestion();
                    modalBackdrop.classList.add('hidden');
                });
                navigatorGrid.appendChild(button);
            });
            confirmationModal.classList.add('hidden');
            imageViewerModal.classList.add('hidden');
            questionNavigatorModal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
        }

        function handleLogout() {
            showConfirmationModal('Log Out?', 'Are you sure you want to log out?', () => {
                appState.currentUser = null;
                appState.navigationHistory = [];
                usernameInput.value = '';
                passwordInput.value = '';
                showScreen(loginContainer);
                modalBackdrop.classList.add('hidden');
            });
        }
        
        function triggerEndQuiz(isForced = false) {
            if (appState.currentQuiz.isReviewMode) {
                showMainMenuScreen();
                return;
            }
             if (isForced) {
                showResults();
                return;
            }
            showConfirmationModal('End Quiz?', 'Are you sure you want to end the quiz?', () => {
                modalBackdrop.classList.add('hidden');
                showResults();
            });
        }

        function handleBackNavigation() {
            if (appState.navigationHistory.length > 1) {
                appState.navigationHistory.pop();
                const previousPage = appState.navigationHistory[appState.navigationHistory.length - 1];
                previousPage();
            }
        }

        function startFreeTest() {
            if (appState.allQuestions.length === 0) {
                alert("Questions are still loading, please wait a moment.");
                return;
            }
            const shuffled = [...appState.allQuestions].sort(() => 0.5 - Math.random());
            const sampleQuestions = shuffled.slice(0, 10);
            appState.currentUser = { Name: 'Guest', UniqueID: `guest_${Date.now()}`, Role: 'Guest' };
            launchQuiz(sampleQuestions, "Free Sample Test");
        }

        function startIncorrectReview() {
            const incorrectQuestions = appState.currentQuiz.originalQuestions.filter((question, index) => {
                const answer = appState.currentQuiz.originalUserAnswers[index];
                return answer && !answer.isCorrect;
            });
            const pastAnswers = appState.currentQuiz.originalUserAnswers.filter(a => a && !a.isCorrect);
            const config = { isReview: true, pastAnswers: pastAnswers };
            launchQuiz(incorrectQuestions, quizTitle.textContent.replace('Review: ', ''), config);
        }

        async function startFullQuizReview(logId, title) {
            showScreen(quizContainer);
            questionContainer.classList.add('hidden');
            controlsContainer.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            progressText.textContent = 'Loading review...';

            try {
                const response = await fetch(`${API_URL}?request=reviewQuiz&logId=${encodeURIComponent(logId)}&userId=${appState.currentUser.UniqueID}`);
                if (!response.ok) throw new Error('Failed to fetch review data.');
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                const reviewQuestions = data.reviewData.map(item => parseQuestions([item.question])[0]);
                const pastAnswers = data.reviewData.map(item => {
                    const question = parseQuestions([item.question])[0];
                    const correctOption = question.answerOptions.find(opt => opt.isCorrect);
                    return {
                        answer: item.userAnswer,
                        isCorrect: item.userAnswer === correctOption.text
                    };
                });
                
                const config = { isReview: true, pastAnswers: pastAnswers };
                launchQuiz(reviewQuestions, title, config);

            } catch (error) {
                console.error("Error starting full quiz review:", error);
                progressText.textContent = `Error: ${error.message}`;
            }
        }
        
        // --- NOTES FUNCTIONS ---
        function showNotesScreen() {
            showScreen(notesContainer);
            appState.navigationHistory.push(showNotesScreen);
            renderNotes('quizzes');
        }

        function renderNotes(filter) {
            notesList.innerHTML = '';
            document.querySelectorAll('#notes-container .filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`notes-filter-${filter}`).classList.add('active');

            const notesToDisplay = filter === 'quizzes' ? appState.userQuizNotes : appState.userLectureNotes;

            if (notesToDisplay.length === 0) {
                notesList.innerHTML = `<p class="text-center text-slate-500">No notes found for this category.</p>`;
                return;
            }

            notesToDisplay.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = 'p-4 bg-white rounded-lg border border-slate-200 shadow-sm';
                
                let title = 'Note';
                let itemId = null;
                let noteType = '';

                if (filter === 'quizzes') {
                    const question = appState.allQuestions.find(q => q.UniqueID === note.QuizID);
                    title = question ? `Note on: ${question.question.substring(0, 50)}...` : 'Note on deleted question';
                    itemId = note.QuizID;
                    noteType = 'quiz';
                } else {
                    const lecture = Object.values(appState.groupedLectures).flatMap(c => c.topics).find(t => t.id === note.LectureID);
                    title = lecture ? `Note on: ${lecture.name}` : 'Note on deleted lecture';
                    itemId = note.LectureID;
                    noteType = 'lecture';
                }

                noteItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-slate-700 flex-grow">${title}</h4>
                        <div class="flex-shrink-0 ml-4">
                            <button class="edit-note-btn text-blue-500 hover:text-blue-700 mr-2" title="Edit Note"><i class="fas fa-edit"></i></button>
                            <button class="delete-note-btn text-red-500 hover:text-red-700" title="Delete Note"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <p class="text-slate-600 mt-2 whitespace-pre-wrap">${note.NoteText}</p>
                `;

                noteItem.querySelector('.edit-note-btn').addEventListener('click', () => {
                    openNoteModal(noteType, itemId, title.replace('Note on: ', ''));
                });
                noteItem.querySelector('.delete-note-btn').addEventListener('click', () => {
                    handleDeleteNote(noteType, note.UniqueID);
                });

                notesList.appendChild(noteItem);
            });
        }

        function openNoteModal(type, itemId, itemTitle) {
            appState.currentNote = { type, itemId, itemTitle };
            let existingNote;

            if (type === 'quiz') {
                noteModalTitle.textContent = `Note on: ${itemTitle.substring(0, 40)}...`;
                existingNote = appState.userQuizNotes.find(n => n.QuizID === itemId);
            } else { // 'lecture'
                noteModalTitle.textContent = `Note on: ${itemTitle}`;
                existingNote = appState.userLectureNotes.find(n => n.LectureID === itemId);
            }

            noteTextarea.value = existingNote ? existingNote.NoteText : '';
            modalBackdrop.classList.remove('hidden');
            noteModal.classList.remove('hidden');
            imageViewerModal.classList.add('hidden');
            questionNavigatorModal.classList.add('hidden');
            confirmationModal.classList.add('hidden');
        }

        function handleSaveNote() {
            const noteText = noteTextarea.value;
            const { type, itemId } = appState.currentNote;
            const uniqueId = `${appState.currentUser.UniqueID}_${itemId}`;

            const payload = {
                eventType: type === 'quiz' ? 'saveQuizNote' : 'saveLectureNote',
                uniqueId: uniqueId,
                userId: appState.currentUser.UniqueID,
                itemId: itemId,
                noteText: noteText
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            }).catch(err => console.error("Failed to save note:", err));

            // Update local data for immediate UI feedback
            if (type === 'quiz') {
                const existingNoteIndex = appState.userQuizNotes.findIndex(n => n.QuizID === itemId);
                if (existingNoteIndex > -1) {
                    appState.userQuizNotes[existingNoteIndex].NoteText = noteText;
                } else {
                    appState.userQuizNotes.push({ UniqueID: uniqueId, QuizID: itemId, NoteText: noteText });
                }
                if (quizContainer.style.display !== 'none') {
                    quizNoteBtn.classList.toggle('has-note', noteText.length > 0);
                }
            } else {
                const existingNoteIndex = appState.userLectureNotes.findIndex(n => n.LectureID === itemId);
                if (existingNoteIndex > -1) {
                    appState.userLectureNotes[existingNoteIndex].NoteText = noteText;
                } else {
                    appState.userLectureNotes.push({ UniqueID: uniqueId, LectureID: itemId, NoteText: noteText });
                }
                renderLectures(lectureSearchInput.value); // Re-render to update icon
            }

            modalBackdrop.classList.add('hidden');
            noteModal.classList.add('hidden');
        }

        function handleDeleteNote(noteType, uniqueId) {
            showConfirmationModal('Delete Note?', 'Are you sure you want to permanently delete this note?', () => {
                const payload = {
                    eventType: noteType === 'quiz' ? 'deleteQuizNote' : 'deleteLectureNote',
                    uniqueId: uniqueId
                };

                fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                }).catch(err => console.error("Failed to delete note:", err));

                // Update local data for immediate UI feedback
                if (noteType === 'quiz') {
                    appState.userQuizNotes = appState.userQuizNotes.filter(n => n.UniqueID !== uniqueId);
                } else {
                    appState.userLectureNotes = appState.userLectureNotes.filter(n => n.UniqueID !== uniqueId);
                }
                
                // Re-render the currently visible screen if it's affected
                if (notesContainer.style.display !== 'none') {
                    renderNotes(notesFilterQuizzes.classList.contains('active') ? 'quizzes' : 'lectures');
                } else if (lecturesContainer.style.display !== 'none') {
                    renderLectures(lectureSearchInput.value);
                } else if (quizContainer.style.display !== 'none') {
                    const currentQuestion = appState.currentQuiz.questions[appState.currentQuiz.currentQuestionIndex];
                    const hasNote = appState.userQuizNotes.some(note => note.QuizID === currentQuestion.UniqueID);
                    quizNoteBtn.classList.toggle('has-note', hasNote);
                }

                modalBackdrop.classList.add('hidden');
            });
        }

        function handleClearLogs(logType) {
            let eventType = '';
            if (logType === 'quiz') eventType = 'clearQuizLogs';
            else if (logType === 'lecture') eventType = 'clearLectureLogs';
            else if (logType === 'all') eventType = 'clearAllLogs';
            else return;

            const payload = {
                eventType: eventType,
                userId: appState.currentUser.UniqueID
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            }).catch(err => console.error("Failed to clear logs:", err));

            // Update local data for immediate UI feedback
            if (logType === 'quiz') {
                appState.fullActivityLog = appState.fullActivityLog.filter(log => log.eventType !== 'FinishQuiz');
            } else if (logType === 'lecture') {
                appState.fullActivityLog = appState.fullActivityLog.filter(log => log.eventType !== 'ViewLecture');
            } else {
                appState.fullActivityLog = [];
            }
            renderFilteredLog('all');
            modalBackdrop.classList.add('hidden');
            clearLogModal.classList.add('hidden');
        }

        function updateWatermark(user) {
            const watermarkOverlay = document.getElementById('watermark-overlay');
            if (!user || user.Role === 'Guest') {
                watermarkOverlay.classList.add('hidden');
                return;
            }

            watermarkOverlay.innerHTML = ''; // Clear previous watermark
            const date = new Date().toLocaleDateString('en-GB');

            const watermarkItem = document.createElement('div');
            watermarkItem.className = 'flex flex-col items-end text-slate-900';
            watermarkItem.innerHTML = `
                <img src="https://raw.githubusercontent.com/surgerymastersacademy/MasterTheMRCS/cc0d28b70d6c4475fc05f336831ce9bad503b89c/Final%20MTM%20Round%20Logo%202024.png" alt="Logo" class="h-10 opacity-50" style="filter: invert(1);">
                <span class="font-semibold text-xs">${user.Name}</span>
                <span class="text-xs">${date}</span>
            `;
            watermarkOverlay.appendChild(watermarkItem);
        }

        async function startIncorrectQuestionsQuiz() {
            loader.classList.remove('hidden');
            loadingText.textContent = 'Loading your mistakes...';
            loadingText.classList.remove('hidden');
            try {
                const response = await fetch(`${API_URL}?request=getIncorrectQuestions&userId=${appState.currentUser.UniqueID}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Failed to fetch your mistakes.');
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                if (data.questions.length === 0) {
                    showConfirmationModal('All Clear!', 'You have no incorrect questions to practice. Well done!', () => modalBackdrop.classList.add('hidden'));
                    return;
                }
                
                const mistakeQuestions = parseQuestions(data.questions);
                const shuffled = [...mistakeQuestions].sort(() => Math.random() - 0.5);
                launchQuiz(shuffled, "Practice Mistakes", { isMistakePractice: true });

            } catch (error) {
                console.error("Error starting mistake practice:", error);
                mockError.textContent = error.message;
                mockError.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                loadingText.classList.add('hidden');
            }
        }
        
        async function startBookmarkedQuestionsQuiz() {
            const bookmarkedIds = Array.from(appState.bookmarkedQuestions);
            if (bookmarkedIds.length === 0) {
                showConfirmationModal('No Bookmarks', 'You have not bookmarked any questions yet.', () => modalBackdrop.classList.add('hidden'));
                return;
            }
            
            const bookmarkedQuestions = appState.allQuestions.filter(q => bookmarkedIds.includes(q.UniqueID));
            const shuffled = [...bookmarkedQuestions].sort(() => Math.random() - 0.5);
            launchQuiz(shuffled, "Bookmarked Questions");
        }

        function logIncorrectAnswer(questionId, userAnswer) {
            const payload = {
                eventType: 'logIncorrectAnswer',
                userId: appState.currentUser.UniqueID,
                questionId: questionId,
                userAnswer: userAnswer
            };
            fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                .catch(err => console.error("Failed to log incorrect answer:", err));
        }

        function logCorrectedMistake(questionId) {
            const payload = {
                eventType: 'logCorrectedMistake',
                userId: appState.currentUser.UniqueID,
                questionId: questionId
            };
            fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
                .catch(err => console.error("Failed to log corrected mistake:", err));
        }

        function displayAnnouncement() {
            const banner = document.getElementById('announcement-banner');
            if (appState.allAnnouncements.length === 0) {
                banner.classList.add('hidden');
                return;
            }

            const latestAnnouncement = appState.allAnnouncements[0];
            const seenAnnouncementId = localStorage.getItem('seenAnnouncementId');
            
            if (seenAnnouncementId === latestAnnouncement.UniqueID) {
                banner.classList.add('hidden');
                return;
            }

            banner.innerHTML = `
                <div class="mb-4 p-4 bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 rounded-lg relative">
                    <div class="flex">
                        <div class="py-1"><i class="fas fa-bullhorn fa-lg mr-4"></i></div>
                        <div>
                            <p class="font-bold">Latest Update</p>
                            <p class="text-sm">${latestAnnouncement.UpdateMessage}</p>
                        </div>
                    </div>
                    <button id="close-announcement-btn" class="absolute top-0 bottom-0 right-0 px-4 py-3">&times;</button>
                </div>
            `;
            banner.classList.remove('hidden');

            document.getElementById('close-announcement-btn').addEventListener('click', () => {
                banner.classList.add('hidden');
                localStorage.setItem('seenAnnouncementId', latestAnnouncement.UniqueID);
            });
        }
        
        function showAnnouncementsModal() {
            announcementsList.innerHTML = '';
            if (appState.allAnnouncements.length === 0) {
                announcementsList.innerHTML = `<p class="text-center text-slate-500">No announcements right now.</p>`;
            } else {
                appState.allAnnouncements.forEach(ann => {
                    const annItem = document.createElement('div');
                    annItem.className = 'p-3 border-b';
                    const date = new Date(ann.TimeStamp).toLocaleDateString('en-GB');
                    annItem.innerHTML = `
                        <p class="font-bold text-slate-700">${ann.UpdateMessage}</p>
                        <p class="text-xs text-slate-400 text-right mt-1">${date}</p>
                    `;
                    announcementsList.appendChild(annItem);
                });
            }
            modalBackdrop.classList.remove('hidden');
            announcementsModal.classList.remove('hidden');
        }

        // --- OSCE Functions ---
        function showOsceScreen() {
            showScreen(osceContainer);
            appState.navigationHistory.push(showOsceScreen);
        }

        function startOsceSlayer() {
            const casesWithQuestions = appState.allOsceCases.filter(c => appState.allOsceQuestions.some(q => q.CaseID === c.CaseID));

            if (casesWithQuestions.length === 0) {
                osceError.textContent = "No OSCE cases with questions are available to start.";
                osceError.classList.remove('hidden');
                return;
            }
            const shuffled = [...casesWithQuestions].sort(() => Math.random() - 0.5);
            
            const totalQuestions = shuffled.reduce((acc, currentCase) => {
                return acc + appState.allOsceQuestions.filter(q => q.CaseID === currentCase.CaseID).length;
            }, 0);
            
            const totalDuration = totalQuestions * 60; // 1 minute per question
            startOsceQuiz(shuffled, "OSCE Slayer", totalDuration);
        }

        function startCustomOsce() {
            osceError.classList.add('hidden');
            const requestedCount = parseInt(osceCaseCountInput.value, 10);
            if (isNaN(requestedCount) || requestedCount <= 0) {
                osceError.textContent = "Please enter a valid number of cases.";
                osceError.classList.remove('hidden');
                return;
            }

            const timePerQ = parseInt(osceTimePerQInput.value, 10) || 1; // Default to 1 minute
            const timePerQSeconds = timePerQ * 60;

            const selectedChapters = [...chapterSelectOsce.querySelectorAll('input:checked')].map(el => el.value);
            const selectedSources = [...sourceSelectOsce.querySelectorAll('input:checked')].map(el => el.value);
            
            let filteredCases = appState.allOsceCases;
            if (selectedChapters.length > 0) filteredCases = filteredCases.filter(c => selectedChapters.includes(c.Chapter));
            if (selectedSources.length > 0) filteredCases = filteredCases.filter(c => selectedSources.includes(c.Source));

            const casesWithQuestions = filteredCases.filter(c => appState.allOsceQuestions.some(q => q.CaseID === c.CaseID));

            if (casesWithQuestions.length === 0) {
                osceError.textContent = "No cases with questions match the selected filters.";
                osceError.classList.remove('hidden');
                return;
            }
            if (requestedCount > casesWithQuestions.length) {
                osceError.textContent = `Only ${casesWithQuestions.length} cases match your filters.`;
                osceError.classList.remove('hidden');
                return;
            }

            const shuffled = [...casesWithQuestions].sort(() => Math.random() - 0.5);
            const mockCases = shuffled.slice(0, requestedCount);

            const totalQuestions = mockCases.reduce((acc, currentCase) => {
                return acc + appState.allOsceQuestions.filter(q => q.CaseID === currentCase.CaseID).length;
            }, 0);

            const totalDuration = totalQuestions * timePerQSeconds;
            startOsceQuiz(mockCases, "Custom OSCE", totalDuration);
        }
        
        function startOsceQuiz(cases, title, totalDuration) {
            appState.currentOsce.cases = cases;
            appState.currentOsce.caseIndex = 0;
            appState.currentOsce.questionIndex = 0;
            appState.currentOsce.userAnswers = {};
            appState.currentOsce.score = 0;
            appState.currentOsce.totalQuestions = cases.reduce((acc, c) => acc + appState.allOsceQuestions.filter(q => q.CaseID === c.CaseID).length, 0);

            showScreen(osceQuizContainer);
            resultsContainer.classList.add('hidden'); // Hide results from previous quiz
            osceQuizTitle.textContent = title;
            startOsceTimer(totalDuration);
            updateOsceScoreDisplay();
            renderOsceQuestion();
        }

        function renderOsceQuestion() {
            const { cases, caseIndex, questionIndex } = appState.currentOsce;
            const currentCase = cases[caseIndex];
            const caseQuestions = appState.allOsceQuestions.filter(q => q.CaseID === currentCase.CaseID);
            const currentQuestion = caseQuestions[questionIndex];

            if (!currentQuestion) {
                console.error("OSCE Error: Could not find a question for the current case/index.", { case: currentCase, index: questionIndex });
                handleOsceNext();
                return;
            }

            // Render Case Info
            osceCaseTitle.textContent = currentCase.Title;
            osceCaseDescription.textContent = currentCase.CaseDescription;
            osceCaseImageContainer.innerHTML = '';
            if (currentCase.ImageURL) {
                const img = document.createElement('img');
                img.src = currentCase.ImageURL;
                img.alt = 'Case Image';
                img.className = 'max-h-64 rounded-lg mx-auto mb-4 cursor-pointer';
                img.addEventListener('click', () => showImageModal(currentCase.ImageURL));
                osceCaseImageContainer.appendChild(img);
            }

            // Render Question Info
            osceProgressText.textContent = `Case ${caseIndex + 1}/${cases.length} - Question ${questionIndex + 1}/${caseQuestions.length}`;
            osceQuestionText.textContent = currentQuestion.QuestionText;
            osceQuestionImageContainer.innerHTML = '';
            if (currentQuestion.ImageURL) {
                const img = document.createElement('img');
                img.src = currentQuestion.ImageURL;
                img.alt = 'Question Image';
                img.className = 'max-h-48 rounded-lg mx-auto mb-4 cursor-pointer';
                img.addEventListener('click', () => showImageModal(currentQuestion.ImageURL));
                osceQuestionImageContainer.appendChild(img);
            }

            // Render Answer Area
            osceAnswerArea.innerHTML = '';
            osceModelAnswerArea.innerHTML = '';
            osceModelAnswerArea.classList.add('hidden');
            osceSelfCorrectionArea.innerHTML = '';
            osceSelfCorrectionArea.classList.add('hidden');
            
            const answerKey = `${currentCase.CaseID}_${currentQuestion.QuestionID}`;
            const userAnswer = appState.currentOsce.userAnswers[answerKey];

            if (currentQuestion.QuestionType === 'MCQ') {
                const shuffledAnswers = [...currentQuestion.answerOptions].sort(() => Math.random() - 0.5);
                shuffledAnswers.forEach(answer => {
                    const button = document.createElement('button');
                    button.textContent = answer.text;
                    button.className = 'answer-btn w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-slate-200 border-2 border-transparent';
                    button.dataset.correct = answer.isCorrect;
                    button.dataset.text = answer.text;
                    button.addEventListener('click', () => selectOsceAnswer(answer));
                    osceAnswerArea.appendChild(button);
                });
                if (userAnswer) {
                    showOsceMcqResult();
                }
            } else { // Essay or default
                if (userAnswer) {
                    osceModelAnswerArea.innerHTML = `<p class="font-semibold">Model Answer:</p><p>${currentQuestion.EssayModelAnswer}</p>`;
                    osceModelAnswerArea.classList.remove('hidden');
                    osceSelfCorrectionArea.innerHTML = `<p class="text-center font-bold text-slate-600">You marked this as ${userAnswer.isCorrect ? 'Correct' : 'Incorrect'}.</p>`;
                    osceSelfCorrectionArea.classList.remove('hidden');
                } else {
                    const showAnswerBtn = document.createElement('button');
                    showAnswerBtn.textContent = 'Show Model Answer';
                    showAnswerBtn.className = 'action-btn bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700';
                    showAnswerBtn.onclick = () => {
                        osceModelAnswerArea.innerHTML = `<p class="font-semibold">Model Answer:</p><p>${currentQuestion.EssayModelAnswer}</p>`;
                        osceModelAnswerArea.classList.remove('hidden');
                        showAnswerBtn.classList.add('hidden');
                        osceSelfCorrectionArea.classList.remove('hidden');
                        osceSelfCorrectionArea.innerHTML = `
                            <p class="text-center font-semibold mb-2">Did you get it right?</p>
                            <div class="flex justify-center gap-4">
                                <button class="self-correct-btn action-btn bg-green-500 text-white font-bold py-2 px-4 rounded-lg" data-correct="true">Correct</button>
                                <button class="self-correct-btn action-btn bg-red-500 text-white font-bold py-2 px-4 rounded-lg" data-correct="false">Incorrect</button>
                            </div>
                        `;
                        osceSelfCorrectionArea.querySelectorAll('.self-correct-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => handleOsceSelfCorrection(e.target.dataset.correct === 'true'));
                        });
                    };
                    osceAnswerArea.appendChild(showAnswerBtn);
                }
            }

            // Update button states
            oscePreviousBtn.disabled = caseIndex === 0 && questionIndex === 0;
            osceNextBtn.textContent = (caseIndex === cases.length - 1 && questionIndex === caseQuestions.length - 1) ? 'Finish' : 'Next';
        }

        function selectOsceAnswer(selectedAnswer) {
            const { cases, caseIndex, questionIndex } = appState.currentOsce;
            const currentCase = cases[caseIndex];
            const caseQuestions = appState.allOsceQuestions.filter(q => q.CaseID === currentCase.CaseID);
            const currentQuestion = caseQuestions[questionIndex];
            if (!currentQuestion) return;

            const answerKey = `${currentCase.CaseID}_${currentQuestion.QuestionID}`;
            if (appState.currentOsce.userAnswers[answerKey]) return; // Already answered

            appState.currentOsce.userAnswers[answerKey] = { answer: selectedAnswer.text, isCorrect: selectedAnswer.isCorrect };
            if (selectedAnswer.isCorrect) {
                appState.currentOsce.score++;
            }
            updateOsceScoreDisplay();
            showOsceMcqResult();
        }

        function showOsceMcqResult() {
            const { cases, caseIndex, questionIndex, userAnswers } = appState.currentOsce;
            const currentCase = cases[caseIndex];
            const caseQuestions = appState.allOsceQuestions.filter(q => q.CaseID === currentCase.CaseID);
            const currentQuestion = caseQuestions[questionIndex];
            const answerKey = `${currentCase.CaseID}_${currentQuestion.QuestionID}`;
            const userAnswer = userAnswers[answerKey];

            Array.from(osceAnswerArea.querySelectorAll('.answer-btn')).forEach(button => {
                button.disabled = true;
                if (button.dataset.correct === 'true') {
                    button.classList.add('correct');
                } else if (userAnswer && button.dataset.text === userAnswer.answer) {
                    button.classList.add('incorrect', 'user-choice');
                }
            });
        }

        function handleOsceSelfCorrection(isCorrect) {
            const { cases, caseIndex, questionIndex } = appState.currentOsce;
            const currentCase = cases[caseIndex];
            const caseQuestions = appState.allOsceQuestions.filter(q => q.CaseID === currentCase.CaseID);
            const currentQuestion = caseQuestions[questionIndex];
            const answerKey = `${currentCase.CaseID}_${currentQuestion.QuestionID}`;

            if (appState.currentOsce.userAnswers[answerKey]) return; // Already answered

            appState.currentOsce.userAnswers[answerKey] = { answer: isCorrect ? 'Correct' : 'Incorrect', isCorrect: isCorrect };
            if (isCorrect) {
                appState.currentOsce.score++;
            }
            updateOsceScoreDisplay();
            osceSelfCorrectionArea.innerHTML = `<p class="text-center font-bold text-slate-600">Your answer has been recorded.</p>`;
        }

        function updateOsceScoreDisplay() {
            const { score, totalQuestions } = appState.currentOsce;
            osceScoreDisplay.textContent = `Score: ${score}/${totalQuestions}`;
        }

        function startOsceTimer(durationInSeconds) {
            clearInterval(appState.currentOsce.timerInterval);
            let timeLeft = durationInSeconds;
            osceTimer.textContent = formatTime(timeLeft);
            appState.currentOsce.timerInterval = setInterval(() => {
                timeLeft--;
                osceTimer.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(appState.currentOsce.timerInterval);
                    endOsceQuiz(true); // Force end due to time up
                }
            }, 1000);
        }

        function handleOsceNext() {
            const { cases, caseIndex, questionIndex } = appState.currentOsce;
            const currentCase = cases[caseIndex];
            const caseQuestions = appState.allOsceQuestions.filter(q => q.CaseID === currentCase.CaseID);

            if (questionIndex < caseQuestions.length - 1) {
                appState.currentOsce.questionIndex++;
            } else if (caseIndex < cases.length - 1) {
                appState.currentOsce.caseIndex++;
                appState.currentOsce.questionIndex = 0;
            } else {
                endOsceQuiz(true); // Force end as it's the last question
                return;
            }
            renderOsceQuestion();
        }

        function handleOscePrevious() {
            if (appState.currentOsce.questionIndex > 0) {
                appState.currentOsce.questionIndex--;
            } else if (appState.currentOsce.caseIndex > 0) {
                appState.currentOsce.caseIndex--;
                const prevCase = appState.currentOsce.cases[appState.currentOsce.caseIndex];
                const prevCaseQuestions = appState.allOsceQuestions.filter(q => q.CaseID === prevCase.CaseID);
                appState.currentOsce.questionIndex = prevCaseQuestions.length - 1;
            }
            renderOsceQuestion();
        }

        function endOsceQuiz(isForced = false) {
            clearInterval(appState.currentOsce.timerInterval);
            if (isForced) {
                showOsceResults();
            } else {
                showConfirmationModal('End OSCE?', 'Are you sure you want to end this OSCE session?', () => {
                    modalBackdrop.classList.add('hidden');
                    showOsceResults();
                });
            }
        }

        function showOsceResults() {
            showScreen(quizContainer);
            
            questionContainer.classList.add('hidden');
            controlsContainer.classList.add('hidden');
            
            resultsContainer.classList.remove('hidden');
            
            resultsTitle.textContent = "OSCE Complete!";
            resultsScoreText.innerHTML = `Your score is <span id="score-text" class="font-bold">${appState.currentOsce.score}</span> out of <span id="total-questions" class="font-bold">${appState.currentOsce.totalQuestions}</span>.`;
            
            restartBtn.classList.add('hidden'); 
            reviewIncorrectBtn.classList.add('hidden'); 
        }

        function showOsceNavigator() {
            osceNavigatorContent.innerHTML = '';
            appState.currentOsce.cases.forEach((caseItem, caseIdx) => {
                const caseDiv = document.createElement('div');
                caseDiv.className = 'border-b pb-2';
                const caseTitle = document.createElement('h4');
                caseTitle.className = 'font-bold text-slate-700';
                caseTitle.textContent = `Case ${caseIdx + 1}: ${caseItem.Title}`;
                caseDiv.appendChild(caseTitle);

                const questionsGrid = document.createElement('div');
                questionsGrid.className = 'grid grid-cols-5 sm:grid-cols-8 gap-2 mt-2';
                
                const caseQuestions = appState.allOsceQuestions.filter(q => q.CaseID === caseItem.CaseID);
                caseQuestions.forEach((q, qIdx) => {
                    const button = document.createElement('button');
                    button.textContent = qIdx + 1;
                    button.className = 'navigator-btn w-10 h-10 rounded-md font-semibold flex items-center justify-center';
                    const answerKey = `${caseItem.CaseID}_${q.QuestionID}`;
                    const answer = appState.currentOsce.userAnswers[answerKey];

                    if (!answer) {
                        button.classList.add('unanswered');
                    } else if (answer.isCorrect) {
                        button.classList.add('correct');
                    } else {
                        button.classList.add('incorrect');
                    }

                    button.addEventListener('click', () => {
                        appState.currentOsce.caseIndex = caseIdx;
                        appState.currentOsce.questionIndex = qIdx;
                        renderOsceQuestion();
                        modalBackdrop.classList.add('hidden');
                    });
                    questionsGrid.appendChild(button);
                });
                caseDiv.appendChild(questionsGrid);
                osceNavigatorContent.appendChild(caseDiv);
            });

            modalBackdrop.classList.remove('hidden');
            osceNavigatorModal.classList.remove('hidden');
        }

        // --- ADDED: Learning Mode Functions ---
        function showLearningModeBrowseScreen() {
            showScreen(learningModeContainer);
            learningModeControls.classList.remove('hidden');
            learningModeViewer.classList.add('hidden');
            appState.navigationHistory.push(showLearningModeBrowseScreen);
        }

        function launchLearningMode(title, questions) {
            showScreen(learningModeContainer); 

            appState.currentLearning.questions = questions;
            appState.currentLearning.currentIndex = 0;
            appState.currentLearning.title = title;
            
            learningModeControls.classList.add('hidden');
            learningModeViewer.classList.remove('hidden');
            learningTitle.textContent = `Studying: ${title}`;

            showLearningQuestion();
        }

        function showLearningQuestion() {
            const { questions, currentIndex } = appState.currentLearning;
            const currentQuestion = questions[currentIndex];

            learningImageContainer.innerHTML = '';
            if (currentQuestion.ImageURL) {
                const img = document.createElement('img');
                img.src = currentQuestion.ImageURL;
                img.alt = 'Question Image';
                img.className = 'max-h-48 rounded-lg mx-auto mb-4 cursor-pointer hover:opacity-80 transition-opacity';
                img.addEventListener('click', () => showImageModal(currentQuestion.ImageURL));
                learningImageContainer.appendChild(img);
            }

            learningQuestionText.textContent = currentQuestion.question;
            learningProgressText.textContent = `Question ${currentIndex + 1} of ${questions.length}`;
            learningSourceText.textContent = `Source: ${currentQuestion.source || 'N/A'} | Chapter: ${currentQuestion.chapter || 'N/A'}`;
            
            learningAnswerButtons.innerHTML = '';
            currentQuestion.answerOptions.forEach(answer => {
                const answerDiv = document.createElement('div');
                const button = document.createElement('button');
                button.textContent = answer.text;
                button.className = 'learning-answer-btn w-full text-left p-4 rounded-lg';
                button.disabled = true;

                if (answer.isCorrect) {
                    button.classList.add('correct');
                    const rationale = document.createElement('p');
                    rationale.className = 'learning-rationale';
                    rationale.textContent = answer.rationale || 'No rationale provided for this answer.';
                    answerDiv.appendChild(button);
                    answerDiv.appendChild(rationale);
                } else {
                    answerDiv.appendChild(button);
                }
                
                learningAnswerButtons.appendChild(answerDiv);
            });

            learningPreviousBtn.disabled = currentIndex === 0;
            learningPreviousBtn.classList.toggle('opacity-50', currentIndex === 0);

            learningNextBtn.disabled = currentIndex === questions.length - 1;
            learningNextBtn.classList.toggle('opacity-50', currentIndex === questions.length - 1);
        }

        function handleLearningNext() {
            if (appState.currentLearning.currentIndex < appState.currentLearning.questions.length - 1) {
                appState.currentLearning.currentIndex++;
                showLearningQuestion();
            }
        }

        function handleLearningPrevious() {
            if (appState.currentLearning.currentIndex > 0) {
                appState.currentLearning.currentIndex--;
                showLearningQuestion();
            }
        }
        
        function handleLearningSearch() {
            const searchTerm = learningSearchInput.value.trim().toLowerCase();
            if (searchTerm.length < 3) {
                learningSearchError.textContent = 'Please enter at least 3 characters to search.';
                learningSearchError.classList.remove('hidden');
                return;
            }
            learningSearchError.classList.add('hidden');

            const filteredQuestions = appState.allQuestions.filter(q => 
                q.question.toLowerCase().includes(searchTerm) || 
                q.answerOptions.some(opt => opt.text.toLowerCase().includes(searchTerm))
            );

            if (filteredQuestions.length === 0) {
                learningSearchError.textContent = `No questions found for "${learningSearchInput.value}".`;
                learningSearchError.classList.remove('hidden');
            } else {
                launchLearningMode(`Search Results for "${learningSearchInput.value}"`, filteredQuestions);
            }
        }
        
        function handleQBankSearch() {
            const searchTerm = qbankSearchInput.value.trim().toLowerCase();
            const errorEl = qbankSearchError;
            errorEl.classList.add('hidden');
            qbankSearchResultsContainer.classList.add('hidden');

            if (searchTerm.length < 3) {
                errorEl.textContent = 'Please enter at least 3 characters to search.';
                errorEl.classList.remove('hidden');
                return;
            }

            const filteredQuestions = appState.allQuestions.filter(q => 
                q.question.toLowerCase().includes(searchTerm) || 
                q.answerOptions.some(opt => opt.text.toLowerCase().includes(searchTerm))
            );

            appState.qbankSearchResults = filteredQuestions; // Store results

            if (filteredQuestions.length === 0) {
                errorEl.textContent = `No questions found for "${qbankSearchInput.value}".`;
                errorEl.classList.remove('hidden');
            } else {
                const sources = [...new Set(filteredQuestions.map(q => q.source || 'N/A'))].join(', ');
                qbankSearchResultsInfo.textContent = `Found ${filteredQuestions.length} questions for "${qbankSearchInput.value}". Sources: ${sources}`;
                qbankSearchResultsContainer.classList.remove('hidden');
            }
        }

        function startSearchedQuiz() {
            const requestedCount = parseInt(qbankSearchQCount.value, 10);
            const errorEl = qbankSearchError;
            errorEl.classList.add('hidden');

            const questionsToUse = appState.qbankSearchResults;

            if (isNaN(requestedCount) || requestedCount <= 0) {
                // If input is empty, use all questions
                const shuffled = [...questionsToUse].sort(() => Math.random() - 0.5);
                launchQuiz(shuffled, `Quiz for "${qbankSearchInput.value}"`);
            } else {
                if (requestedCount > questionsToUse.length) {
                    errorEl.textContent = `Only ${questionsToUse.length} questions found. Please request a smaller number.`;
                    errorEl.classList.remove('hidden');
                } else {
                    const shuffled = [...questionsToUse].sort(() => Math.random() - 0.5);
                    const quizQuestions = shuffled.slice(0, requestedCount);
                    launchQuiz(quizQuestions, `Quiz for "${qbankSearchInput.value}"`);
                }
            }
        }

        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', handleLogin);
        freeTestBtn.addEventListener('click', startFreeTest);
        lecturesBtn.addEventListener('click', showLecturesScreen);
        qbankBtn.addEventListener('click', showQbankScreen);
        libraryBtn.addEventListener('click', showLibraryScreen);
        notesBtn.addEventListener('click', showNotesScreen);
        leaderboardBtn.addEventListener('click', showLeaderboardScreen);
        announcementsBtn.addEventListener('click', showAnnouncementsModal);
        osceBtn.addEventListener('click', showOsceScreen);
        learningModeBtn.addEventListener('click', showLearningModeBrowseScreen);
        
        const backButtons = [lecturesBackBtn, qbankBackBtn, listBackBtn, activityBackBtn, libraryBackBtn, notesBackBtn, leaderboardBackBtn, osceBackBtn, learningModeBackBtn];
        backButtons.forEach(btn => btn.addEventListener('click', handleBackNavigation));

        globalHomeBtn.addEventListener('click', () => {
            if (appState.currentUser && appState.currentUser.Role === 'Guest') {
                showScreen(loginContainer);
                appState.currentUser = null;
            } else {
                showMainMenuScreen();
            }
        });
        logoutBtn.addEventListener('click', handleLogout);
        activityLogBtn.addEventListener('click', showActivityLog);

        logFilterAll.addEventListener('click', () => renderFilteredLog('all'));
        logFilterQuizzes.addEventListener('click', () => renderFilteredLog('quizzes'));
        logFilterLectures.addEventListener('click', () => renderFilteredLog('lectures'));

        notesFilterQuizzes.addEventListener('click', () => renderNotes('quizzes'));
        notesFilterLectures.addEventListener('click', () => renderNotes('lectures'));

        lectureSearchInput.addEventListener('keyup', (e) => renderLectures(e.target.value));

        startMockBtn.addEventListener('click', handleMockExamStart);
        browseByChapterBtn.addEventListener('click', () => showChapterList('All', false));
        browseBySourceBtn.addEventListener('click', () => showSourceList(false));
        toggleCustomOptionsBtn.addEventListener('click', () => customExamOptions.classList.toggle('visible'));
        practiceMistakesBtn.addEventListener('click', startIncorrectQuestionsQuiz);
        practiceBookmarkedBtn.addEventListener('click', startBookmarkedQuestionsQuiz);

        // --- START: ADD SIMULATION EVENT LISTENER ---
        startSimulationBtn.addEventListener('click', handleStartSimulation);
        // --- END: ADD SIMULATION EVENT LISTENER ---

        hintBtn.addEventListener('click', () => hintText.classList.remove('hidden'));
        flagBtn.addEventListener('click', toggleFlag);
        endQuizBtn.addEventListener('click', () => triggerEndQuiz(false));
        previousBtn.addEventListener('click', handlePreviousQuestion);
        nextSkipBtn.addEventListener('click', handleNextQuestion);
        restartBtn.addEventListener('click', () => launchQuiz(appState.currentQuiz.originalQuestions, quizTitle.textContent.replace('Review: ', '')));
        resultsHomeBtn.addEventListener('click', () => {
            if (appState.currentUser.Role === 'Guest') {
                showScreen(loginContainer);
                appState.currentUser = null;
            } else {
                showMainMenuScreen();
            }
        });
        reviewIncorrectBtn.addEventListener('click', startIncorrectReview);

        quizNoteBtn.addEventListener('click', () => {
            const currentQuestion = appState.currentQuiz.questions[appState.currentQuiz.currentQuestionIndex];
            openNoteModal('quiz', currentQuestion.UniqueID, currentQuestion.question);
        });

        toggleOsceOptionsBtn.addEventListener('click', () => customOsceOptions.classList.toggle('visible'));
        startOsceSlayerBtn.addEventListener('click', startOsceSlayer);
        startCustomOsceBtn.addEventListener('click', startCustomOsce);
        endOsceQuizBtn.addEventListener('click', () => endOsceQuiz(false));
        osceNextBtn.addEventListener('click', handleOsceNext);
        oscePreviousBtn.addEventListener('click', handleOscePrevious);
        osceNavigatorBtn.addEventListener('click', showOsceNavigator);
        osceNavigatorCloseBtn.addEventListener('click', () => modalBackdrop.classList.add('hidden'));

        learningBrowseByChapterBtn.addEventListener('click', () => showChapterList('All', true));
        learningBrowseBySourceBtn.addEventListener('click', () => showSourceList(true));
        endLearningBtn.addEventListener('click', showLearningModeBrowseScreen);
        learningNextBtn.addEventListener('click', handleLearningNext);
        learningPreviousBtn.addEventListener('click', handleLearningPrevious);
        learningSearchBtn.addEventListener('click', handleLearningSearch);
        qbankSearchBtn.addEventListener('click', handleQBankSearch);
        qbankStartSearchQuizBtn.addEventListener('click', startSearchedQuiz);

        modalCancelBtn.addEventListener('click', () => modalBackdrop.classList.add('hidden'));
        modalConfirmBtn.addEventListener('click', () => { if (appState.modalConfirmAction) appState.modalConfirmAction(); });
        navigatorBtn.addEventListener('click', showQuestionNavigator);
        navigatorCloseBtn.addEventListener('click', () => modalBackdrop.classList.add('hidden'));
        imageViewerCloseBtn.addEventListener('click', () => modalBackdrop.classList.add('hidden'));
        noteCancelBtn.addEventListener('click', () => {
            modalBackdrop.classList.add('hidden');
            noteModal.classList.add('hidden');
        });
        noteSaveBtn.addEventListener('click', handleSaveNote);
        announcementsCloseBtn.addEventListener('click', () => {
            modalBackdrop.classList.add('hidden');
            announcementsModal.classList.add('hidden');
        });
        
        clearLogBtn.addEventListener('click', () => {
            modalBackdrop.classList.remove('hidden');
            clearLogModal.classList.remove('hidden');
        });
        clearLogCancelBtn.addEventListener('click', () => {
            modalBackdrop.classList.add('hidden');
            clearLogModal.classList.add('hidden');
        });
        clearQuizLogsBtn.addEventListener('click', () => handleClearLogs('quiz'));
        clearLectureLogsBtn.addEventListener('click', () => handleClearLogs('lecture'));
        clearAllLogsBtn.addEventListener('click', () => handleClearLogs('all'));
        
        radioBtn.addEventListener('click', () => {
            radioBannerContainer.classList.toggle('open');
        });
        radioCloseBtn.addEventListener('click', () => {
            radioBannerContainer.classList.remove('open');
        });
        
        sourceSelectMock.addEventListener('change', updateChapterFilter);
        selectAllSourcesMock.addEventListener('change', (e) => {
            sourceSelectMock.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateChapterFilter();
        });

        selectAllChaptersMock.addEventListener('change', (e) => {
            chapterSelectMock.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        // --- INITIAL LOAD ---
        loadContentData();
    });
    </script>

</body>
</html>
